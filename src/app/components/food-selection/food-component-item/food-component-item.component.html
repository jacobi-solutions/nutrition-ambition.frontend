
<!-- Individual Component Item -->
<div *ngIf="component" class="food-item-row-simple" [id]="'row-' + component.componentId" [class.searching]="isSearching">

  <!-- Loading overlay when searching -->
  <div *ngIf="isSearching" class="search-loading-overlay">
    <div class="loading-content">
      <div class="loading-dots-large">...</div>
      <div class="loading-text">Searching for better results...</div>
    </div>
  </div>

  <ion-grid class="row-grid" *ngIf="!isSearching">
    <ion-row class="top-row" align-items-center>
      <ion-col size="10" class="left">
        <div class="name-section">
          <span class="name">{{ getDisplayName() | titlecase}}</span>
          <span *ngIf="getIsInferred()" class="inferred-badge">(inferred)</span>
          <span *ngIf="getBrandName()" class="brand-name"> – {{ getBrandName() }}</span>
        </div>
        <div class="serving-line">
          <span class="inline-amount">{{ getServingLabel() }}</span>
        </div>
      </ion-col>
      <ion-col size="2" class="right" *ngIf="!isReadOnly">
        <div class="action-icons">
          <ion-icon
            [name]="isExpanded ? 'chevron-up-outline' : 'create-outline'"
            class="edit-icon"
            [class.expanded]="isExpanded"
            (click)="onToggleExpansion()">
          </ion-icon>
          <ion-icon
            *ngIf="!isEditMode"
            name="trash-outline"
            class="delete-icon"
            (click)="onRemoveComponent()">
          </ion-icon>
        </div>
      </ion-col>
    </ion-row>
  </ion-grid>
</div>

<!-- Expanded component selection card -->
<div *ngIf="!isReadOnly && isExpanded" class="expanded-food-selection">
  <div class="drilldown-content">
    <div class="food-item-row">
      <div class="food-name">
        <div class="original-phrase-header">
          <div class="phrase-edit-container" [attr.data-component-id]="component.componentId">
            <!-- Display mode: Bold text with edit icon -->
            <div *ngIf="!isEditing" class="phrase-display-mode">
              <strong class="phrase-text">{{ getDisplayName() | titlecase}}</strong>
              <span *ngIf="getIsInferred()" class="inferred-badge">(inferred)</span>
              <ion-icon
                name="create-outline"
                class="edit-phrase-icon"
                (click)="onEditStarted()">
              </ion-icon>
            </div>

            <!-- Edit mode: Textarea with send button -->
            <div *ngIf="isEditing" class="phrase-edit-mode">
              <textarea
                #phraseInput
                class="phrase-input"
                [value]="editingValue"
                (input)="onEditingValueChanged($event)"
                (blur)="onTextareaBlur($event)"
                (keydown)="onComponentKeyDown($event)"
                placeholder="Describe your food..."
                autoFocus>
              </textarea>
              <button
                class="send-button"
                (click)="onEditConfirmed(editingValue)"
                (mousedown)="$event.preventDefault()"
                [disabled]="!hasEditChanges()"
                type="button">
                <ion-icon name="send"></ion-icon>
              </button>
            </div>
          </div>
        </div>
        <div class="food-select-container">
          <ion-select
            interface="popover"
            [interfaceOptions]="{ cssClass: 'wide-select-popover scrollable-popover' }"
            [value]="getSelectedFoodId()"
            (ionChange)="onFoodSelectedFromDropdown($event.detail.value)"
            (ionFocus)="onDropdownWillOpen()"
            [disabled]="isReadOnly"
            id="foodSelect-{{ component.componentId }}">
            <ion-select-option
              *ngFor="let match of getDisplayMatches()"
              [value]="match.providerFoodId"
              [disabled]="match.providerFoodId === 'loading'">
              <span *ngIf="match.providerFoodId === 'loading'" class="loading-dots">...</span>
              <span *ngIf="match.providerFoodId !== 'loading'">
                {{ match.displayName }}
                <span *ngIf="match.brandName" class="brand-name"> – {{ match.brandName }}</span>
              </span>
            </ion-select-option>
          </ion-select>
        </div>

        <!-- More options list -->
        <div *ngIf="showingMoreOptions" class="more-options-list">
          <div class="more-options-header">More options for "{{ getOriginalPhrase() }}":</div>
          <ion-list class="more-options-items">
            <ion-item
              *ngFor="let alternative of moreOptions"
              button
              (click)="onMoreOptionSelected(alternative)">
              <ion-label>
                <h3>{{ alternative.displayName }}</h3>
                <p *ngIf="alternative.brandName">{{ alternative.brandName }}</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>
      </div>

      <div class="serving-options-inline">
        <ion-radio-group
          [value]="getSelectedServingId()"
          (ionChange)="onServingSelectedFromRadio($event.detail.value)">
          <ion-radio
            *ngFor="let serving of getServingOptions(); trackBy: trackByServingId"
            [value]="serving.providerServingId"
            [disabled]="isReadOnly"
            (click)="onRowClicked(serving)">
            <div class="serving-row-content" (click)="$event.stopPropagation(); onRowClicked(serving)">
              <!-- Show stepper only for selected row -->
              <ng-container *ngIf="isServingSelected(serving) && !isReadOnly">
                <app-serving-quantity-input
                  [value]="getEffectiveQuantityForServing(serving)"
                  [step]="1"
                  [min]="0.1"
                  [max]="999"
                  [disabled]="isReadOnly"
                  [ariaLabel]="'Quantity for ' + getUnitTextForServing(serving)"
                  (click)="$event.stopPropagation(); onRowClicked(serving)"
                  (valueChange)="onServingQuantityChanged(serving, $event)">
                </app-serving-quantity-input>
                <span class="unit-label">{{ getUnitTextForServing(serving) }}</span>
              </ng-container>
              <!-- Show normal label for unselected rows or read-only mode -->
              <ng-container *ngIf="!isServingSelected(serving) || isReadOnly">
                <span class="serving-label">{{ getServingLabelForServing(serving) }}</span>
              </ng-container>
            </div>
          </ion-radio>
        </ion-radio-group>
      </div>
    </div>
  </div>
</div>