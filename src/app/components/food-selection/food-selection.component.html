<div class="food-selection-container" [class.read-only]="isReadOnly">
  <div class="food-selection-container-inner">
    
    <!-- Loading state when editing phrase -->
    <div *ngIf="isEditingPhrase" class="editing-phrase-loading">
      <div class="loading-content">
        <div class="loading-dots-large">...</div>
        <div class="loading-text">Searching for better results...</div>
      </div>
    </div>

    <!-- Normal content when not editing phrase -->
    <div *ngIf="!isEditingPhrase">
      <!-- Food items list -->
      <div *ngIf="hasPayload" class="card-header">
        <label><strong>{{ ((message.mealName && message.mealName.trim().length > 0) ? message.mealName : 'Food Items') | titlecase }}</strong></label>
      </div>

      <div *ngIf="hasPayload" class="food-items-list">
      <!-- Loop over foods instead of flattened components -->
      <ng-container *ngFor="let food of (message.logMealToolResponse?.foods || []); let foodIndex = index; let isLast = last; trackBy: trackByFood">
        <div class="food-item-container" [class.is-last]="isLast" *ngIf="getComponentsForFood(food).length > 0">
          
          <!-- Cache components per food to avoid repeated calls -->
          <ng-container *ngIf="getComponentsForFood(food) as foodComponents">
          <!-- Multi-component food: Show as component-style item -->
          <ng-container *ngIf="foodComponents.length > 1">
            <!-- Food header row (styled like component items) -->
            <div class="component-item-container">
              <div class="food-item-row-simple">
                <ion-grid class="row-grid">
                  <ion-row class="top-row" align-items-center>
                    <ion-col size="10" class="left">
                      <div class="name-section">
                        <span class="name">{{ getComputedFoodName(foodIndex) | titlecase }}</span>
                      </div>
                      <div class="serving-line">
                        <!-- Show quantity stepper when expanded -->
                        <ng-container *ngIf="getComputedIsFoodEditingExpanded(foodIndex) && !isReadOnly">
                          <app-serving-quantity-input
                            [value]="editingFoodQuantities[foodIndex] || food.quantity || 1"
                            [step]="1"
                            [min]="1"
                            [max]="999"
                            [disabled]="isReadOnly"
                            [ariaLabel]="'Quantity for ' + food.name"
                            (valueChange)="onFoodQuantityChange(foodIndex, $event)">
                          </app-serving-quantity-input>
                          <span class="unit-label">{{ food.unit || 'servings' }}</span>
                        </ng-container>
                        <!-- Show normal label when collapsed or read-only -->
                        <ng-container *ngIf="!getComputedIsFoodEditingExpanded(foodIndex) || isReadOnly">
                          <span class="inline-amount">{{ getComputedFoodServingLabel(foodIndex) }}</span>
                        </ng-container>
                      </div>
                    </ion-col>
                    <ion-col size="2" class="right" *ngIf="!isReadOnly">
                      <div class="action-icons">
                        <ion-icon 
                          [name]="getComputedIsFoodEditingExpanded(foodIndex) ? 'chevron-up-outline' : 'chevron-down-outline'" 
                          class="edit-icon" 
                          [class.expanded]="getComputedIsFoodEditingExpanded(foodIndex)" 
                          (click)="toggleFoodEditing(foodIndex)">
                        </ion-icon>
                        <ion-icon name="trash-outline" class="delete-icon" (click)="food.id && removeFood(food.id)"></ion-icon>
                      </div>
                    </ion-col>
                  </ion-row>
                  <!-- <ion-row class="macro-row" *ngIf="!isReadOnly">
                    <ion-col size="12" class="macro-summary">
                      ({{ getFoodTotalCaloriesFromComponents(food, foodComponents) | number:'1.0-0' }} cal,
                      {{ getFoodTotalProteinFromComponents(food, foodComponents) | number:'1.0-0' }} protein,
                      {{ getFoodTotalFatFromComponents(food, foodComponents) | number:'1.0-0' }} fat,
                      {{ getFoodTotalCarbsFromComponents(food, foodComponents) | number:'1.0-0' }} carbs)
                    </ion-col>
                  </ion-row> -->
                </ion-grid>
              </div>
            </div>

            <!-- Expanded food editing (quantity + components) -->
            <div *ngIf="!isReadOnly && getComputedIsFoodEditingExpanded(foodIndex)" class="expanded-food-components">
            <ng-container *ngFor="let componentData of foodComponents; trackBy: trackByComponentId">
              <div class="component-item-container">
                <div class="food-item-row-simple" [id]="'row-' + componentData.componentId" [class.searching]="getComputedIsSearching(componentData.componentId)">
                
                <!-- Loading overlay when searching -->
                <div *ngIf="getComputedIsSearching(componentData.componentId)" class="search-loading-overlay">
                  <div class="loading-content">
                    <div class="loading-dots-large">...</div>
                    <div class="loading-text">Searching for better results...</div>
                  </div>
                </div>

                <ion-grid class="row-grid" *ngIf="!getComputedIsSearching(componentData.componentId)">
                  <ion-row class="top-row" align-items-center>
                    <ion-col size="10" class="left">
                      <div class="name-section">
                        <span class="name">{{ getComputedDisplayName(componentData.componentId) | titlecase}}</span>
                        <span *ngIf="getComputedIsInferred(componentData.componentId)" class="inferred-badge">(inferred)</span>
                        <span *ngIf="getComputedBrandName(componentData.componentId)" class="brand-name"> – {{ getComputedBrandName(componentData.componentId) }}</span>
                      </div>
                      <div class="serving-line">
                        <span class="inline-amount">{{ getComputedServingLabel(componentData.componentId) }}</span>
                      </div>
                    </ion-col>
                    <ion-col size="2" class="right" *ngIf="!isReadOnly">
                      <div class="action-icons">
                        <ion-icon [name]="getComputedIsExpanded(componentData.componentId) ? 'chevron-up-outline' : 'create-outline'" class="edit-icon" [class.expanded]="getComputedIsExpanded(componentData.componentId)" (click)="toggleExpansion(componentData.componentId)"></ion-icon>
                        <ion-icon *ngIf="!isEditMode" name="trash-outline" class="delete-icon" (click)="removeItem(componentData.componentId)"></ion-icon>
                      </div>
                    </ion-col>
                  </ion-row>
                  <!-- <ion-row class="macro-row" *ngIf="!isReadOnly && getSelectedServing(componentData.componentId) as selectedServing">
                    <ion-col size="12" class="macro-summary">
                      ({{ caloriesForServing(selectedServing) || 0 | number:'1.0-0' }} cal,
                      {{ proteinForServing(selectedServing) || 0 | number:'1.0-0' }} protein,
                      {{ fatForServing(selectedServing) || 0 | number:'1.0-0' }} fat,
                      {{ carbsForServing(selectedServing) || 0 | number:'1.0-0' }} carbs)
                    </ion-col>
                  </ion-row> -->
                </ion-grid>
              </div>

              <!-- Expanded component selection card -->
              <div *ngIf="!isReadOnly && getComputedIsExpanded(componentData.componentId)" class="expanded-food-selection">
                <div class="drilldown-content">
                  <div class="food-item-row">
                    <div class="food-name">
                      <div class="original-phrase-header">
                        <div class="phrase-edit-container" [attr.data-component-id]="componentData.componentId">
                          <!-- Display mode: Bold text with edit icon -->
                          <div *ngIf="!getComputedIsComponentEditing(componentData.componentId)" class="phrase-display-mode">
                            <strong class="phrase-text">{{ getComputedDisplayName(componentData.componentId) | titlecase}}</strong>
                            <span *ngIf="getComputedIsInferred(componentData.componentId)" class="inferred-badge">(inferred)</span>
                            <ion-icon 
                              name="create-outline" 
                              class="edit-phrase-icon" 
                              (click)="startEditingComponent(componentData.componentId)">
                            </ion-icon>
                          </div>
                          
                          <!-- Edit mode: Textarea with send button -->
                          <div *ngIf="getComputedIsComponentEditing(componentData.componentId)" class="phrase-edit-mode">
                            <textarea 
                              #phraseInput
                              class="phrase-input"
                              [value]="getComputedEditingValue(componentData.componentId)"
                              (input)="updateEditingComponent(componentData.componentId, $event)"
                              (blur)="onTextareaBlur(componentData.componentId, $event)"
                              (keydown)="onComponentKeyDown(componentData.componentId, $event)"
                              placeholder="Describe your food..."
                              autoFocus>
                            </textarea>
                            <button 
                              class="send-button"
                              (click)="sendUpdatedComponent(componentData.componentId)"
                              (mousedown)="$event.preventDefault()"
                              [disabled]="!getComputedHasChanges(componentData.componentId)"
                              type="button">
                              <ion-icon name="send"></ion-icon>
                            </button>
                          </div>
                        </div>
                      </div>
                      <ion-select 
                        interface="popover"
                        [interfaceOptions]="{ cssClass: 'wide-select-popover' }"
                        [value]="getComputedSelectedFoodId(componentData.componentId)" 
                        (ionChange)="onFoodSelected(componentData.componentId, $event.detail.value)" 
                        [disabled]="isReadOnly"
                        id="foodSelect-{{ componentData.componentId }}">
                        <ion-select-option 
                          *ngFor="let match of (componentData.component.matches || [])" 
                          [value]="match.fatSecretFoodId">
                          {{ match.displayName }}
                          <span *ngIf="match.brandName" class="brand-name"> – {{ match.brandName }}</span>
                        </ion-select-option>
                      </ion-select>
                    </div>

                    <div class="serving-options-inline">
                      <ion-radio-group 
                        [value]="getComputedSelectedServingId(componentData.componentId)"
                        (ionChange)="onServingSelected(componentData.componentId, $event.detail.value)">
                        <ion-radio 
                          *ngFor="let serving of getComputedDualServingOptions(componentData.componentId); trackBy: trackByServingId"
                          [value]="serving.fatSecretServingId"
                          [disabled]="isReadOnly"
                          (click)="onRowClicked(componentData.componentId, serving)">
                          <div class="serving-row-content" (click)="$event.stopPropagation(); onRowClicked(componentData.componentId, serving)">
                            <!-- Show stepper only for selected row -->
                            <ng-container *ngIf="getComputedIsServingSelected(componentData.componentId, serving.fatSecretServingId || '') && !isReadOnly">
                              <app-serving-quantity-input
                                [value]="getComputedEffectiveQuantityForServing(componentData.componentId, serving.fatSecretServingId || '')"
                                [step]="1"
                                [min]="0.1"
                                [max]="999"
                                [disabled]="isReadOnly"
                                [ariaLabel]="'Quantity for ' + getComputedUnitTextForServing(componentData.componentId, serving.fatSecretServingId || '')"
                                (click)="$event.stopPropagation(); onRowClicked(componentData.componentId, serving)"
                                (valueChange)="onInlineQtyChanged(componentData.componentId, serving, $event)">
                              </app-serving-quantity-input>
                              <span class="unit-label">{{ getComputedUnitTextForServing(componentData.componentId, serving.fatSecretServingId || '') }}</span>
                            </ng-container>
                            <!-- Show normal label for unselected rows or read-only mode -->
                            <ng-container *ngIf="!getComputedIsServingSelected(componentData.componentId, serving.fatSecretServingId || '') || isReadOnly">
                              <span class="serving-label">{{ getComputedServingLabelForServing(componentData.componentId, serving.fatSecretServingId || '') }}</span>
                            </ng-container>
                          </div>
                          <!-- <div class="macro-inline-servings">
                            ({{ caloriesForServing(serving) || 0 | number:'1.0-0' }} cal, 
                            {{ proteinForServing(serving) || 0 | number:'1.0-0' }} protein, 
                            {{ fatForServing(serving) || 0 | number:'1.0-0' }} fat, 
                            {{ carbsForServing(serving) || 0 | number:'1.0-0' }} carbs)
                          </div> -->
                        </ion-radio>
                      </ion-radio-group>
                    </div>
                  </div>
                </div>
              </div>
              </div> <!-- Close component-item-container -->
            </ng-container>
            
          </div> <!-- Close expanded-food-components -->
          </ng-container> <!-- Close multi-component food -->

          <!-- Single-component food: Display directly as component -->
          <ng-container *ngIf="foodComponents.length === 1">
            <div *ngFor="let componentData of foodComponents; trackBy: trackByComponentId" class="component-item-container">
          <div class="food-item-row-simple" [id]="'row-' + componentData.componentId" [class.searching]="getComputedIsSearching(componentData.componentId)">
          
          <!-- Loading overlay when searching -->
          <div *ngIf="getComputedIsSearching(componentData.componentId)" class="search-loading-overlay">
            <div class="loading-content">
              <div class="loading-dots-large">...</div>
              <div class="loading-text">Searching for better results...</div>
            </div>
          </div>

          <ion-grid class="row-grid" *ngIf="!getComputedIsSearching(componentData.componentId)">
            <ion-row class="top-row" align-items-center>
              <ion-col size="10" class="left">
                <div class="name-section">
                  <span class="name">{{ getComputedDisplayName(componentData.componentId) | titlecase}}</span>
                  <span *ngIf="getComputedIsInferred(componentData.componentId)" class="inferred-badge">(inferred)</span>
                  <span *ngIf="getComputedBrandName(componentData.componentId)" class="brand-name"> – {{ getComputedBrandName(componentData.componentId) }}</span>
                </div>
                <div class="serving-line">
                  <span class="inline-amount">{{ getComputedServingLabel(componentData.componentId) }} ({{ getComputedCalories(componentData.componentId) || 0 | number:'1.0-0' }} cal)</span>
                </div>
              </ion-col>
              <ion-col size="2" class="right" *ngIf="!isReadOnly">
                <div class="action-icons">
                  <ion-icon [name]="getComputedIsExpanded(componentData.componentId) ? 'chevron-up-outline' : 'create-outline'" class="edit-icon" [class.expanded]="getComputedIsExpanded(componentData.componentId)" (click)="toggleExpansion(componentData.componentId)"></ion-icon>
                  <ion-icon *ngIf="!isEditMode" name="trash-outline" class="delete-icon" (click)="removeItem(componentData.componentId)"></ion-icon>
                </div>
              </ion-col>
            </ion-row>
            <!-- <ion-row class="macro-row" *ngIf="!isReadOnly && getSelectedServing(componentData.componentId) as selectedServing">
              <ion-col size="12" class="macro-summary">
                ({{ caloriesForServing(selectedServing) || 0 | number:'1.0-0' }} cal,
                {{ proteinForServing(selectedServing) || 0 | number:'1.0-0' }} protein,
                {{ fatForServing(selectedServing) || 0 | number:'1.0-0' }} fat,
                {{ carbsForServing(selectedServing) || 0 | number:'1.0-0' }} carbs)
              </ion-col>
            </ion-row> -->
          </ion-grid>
        </div>

              <!-- Expanded component selection card for single foods -->
        <div *ngIf="!isReadOnly && getComputedIsExpanded(componentData.componentId)" class="expanded-food-selection">
          <div class="drilldown-content">
            <div class="food-item-row">
              <div class="food-name">
                <div class="original-phrase-header">
                  <div class="phrase-edit-container" [attr.data-component-id]="componentData.componentId">
                    <!-- Display mode: Bold text with edit icon -->
                    <div *ngIf="!getComputedIsComponentEditing(componentData.componentId)" class="phrase-display-mode">
                      <strong class="phrase-text">{{ getComputedDisplayName(componentData.componentId) | titlecase}}</strong>
                      <span *ngIf="getComputedIsInferred(componentData.componentId)" class="inferred-badge">(inferred)</span>
                      <ion-icon 
                        name="create-outline" 
                        class="edit-phrase-icon" 
                        (click)="startEditingComponent(componentData.componentId)">
                      </ion-icon>
                    </div>
                    
                    <!-- Edit mode: Textarea with send button -->
                    <div *ngIf="getComputedIsComponentEditing(componentData.componentId)" class="phrase-edit-mode">
                      <textarea 
                        #phraseInput
                        class="phrase-input"
                        [value]="getComputedEditingValue(componentData.componentId)"
                        (input)="updateEditingComponent(componentData.componentId, $event)"
                        (blur)="onTextareaBlur(componentData.componentId, $event)"
                        (keydown)="onComponentKeyDown(componentData.componentId, $event)"
                        placeholder="Describe your food..."
                        autoFocus>
                      </textarea>
                      <button 
                        class="send-button"
                        (click)="sendUpdatedComponent(componentData.componentId)"
                        (mousedown)="$event.preventDefault()"
                        [disabled]="!getComputedHasChanges(componentData.componentId)"
                        type="button">
                        <ion-icon name="send"></ion-icon>
                      </button>
                    </div>
                  </div>
                </div>
                <ion-select 
                  interface="popover"
                  [interfaceOptions]="{ cssClass: 'wide-select-popover' }"
                  [value]="getComputedSelectedFoodId(componentData.componentId)" 
                  (ionChange)="onFoodSelected(componentData.componentId, $event.detail.value)" 
                  [disabled]="isReadOnly"
                  id="foodSelect-{{ componentData.componentId }}">
                  <ion-select-option 
                    *ngFor="let match of (componentData.component.matches || [])" 
                    [value]="match.fatSecretFoodId">
                    {{ match.displayName }}
                    <span *ngIf="match.brandName" class="brand-name"> – {{ match.brandName }}</span>
                  </ion-select-option>
                </ion-select>
              </div>

              <div class="serving-options-inline">
                <ion-radio-group 
                  [value]="getComputedSelectedServingId(componentData.componentId)"
                  (ionChange)="onServingSelected(componentData.componentId, $event.detail.value)">
                  <ion-radio 
                    *ngFor="let serving of getComputedDualServingOptions(componentData.componentId); trackBy: trackByServingId"
                    [value]="serving.fatSecretServingId"
                    [disabled]="isReadOnly"
                    (click)="onRowClicked(componentData.componentId, serving)">
                    <div class="serving-row-content" (click)="$event.stopPropagation(); onRowClicked(componentData.componentId, serving)">
                      <!-- Show stepper only for selected row -->
                      <ng-container *ngIf="getComputedIsServingSelected(componentData.componentId, serving.fatSecretServingId || '') && !isReadOnly">
                        <app-serving-quantity-input
                          [value]="getComputedEffectiveQuantityForServing(componentData.componentId, serving.fatSecretServingId || '')"
                          [step]="1"
                          [min]="0.1"
                          [max]="999"
                          [disabled]="isReadOnly"
                          [ariaLabel]="'Quantity for ' + getComputedUnitTextForServing(componentData.componentId, serving.fatSecretServingId || '')"
                          (click)="$event.stopPropagation(); onRowClicked(componentData.componentId, serving)"
                          (valueChange)="onInlineQtyChanged(componentData.componentId, serving, $event)">
                        </app-serving-quantity-input>
                        <span class="unit-label">{{ getComputedUnitTextForServing(componentData.componentId, serving.fatSecretServingId || '') }}</span>
                      </ng-container>
                      <!-- Show normal label for unselected rows or read-only mode -->
                      <ng-container *ngIf="!getComputedIsServingSelected(componentData.componentId, serving.fatSecretServingId || '') || isReadOnly">
                        <span class="serving-label">{{ getComputedServingLabelForServing(componentData.componentId, serving.fatSecretServingId || '') }}</span>
                      </ng-container>
                    </div>
                    <!-- <div class="macro-inline-servings">
                      ({{ caloriesForServing(serving) || 0 | number:'1.0-0' }} cal, 
                      {{ proteinForServing(serving) || 0 | number:'1.0-0' }} protein, 
                      {{ fatForServing(serving) || 0 | number:'1.0-0' }} fat, 
                      {{ carbsForServing(serving) || 0 | number:'1.0-0' }} carbs)
                    </div> -->
                  </ion-radio>
                </ion-radio-group>
              </div>
            </div>
          </div>
        </div>
            </div> <!-- Close div for single component -->
          </ng-container> <!-- Close single-component food -->
          </ng-container> <!-- Close cached components container -->

        </div> <!-- Close food-item-container -->
      </ng-container>
    </div>

    <!-- Add something row -->
    <div *ngIf="hasPayload && !isReadOnly && !isEditMode" class="add-something-row">
      <div *ngIf="!isAddingFood" class="add-something-display" (click)="startAddingFood()">
        <div class="add-something-text">Add something</div>
        <ion-icon name="add-circle-outline" class="add-something-icon"></ion-icon>
      </div>
      
      <div *ngIf="isAddingFood" class="add-something-edit">
        <textarea 
          #addFoodTextarea
          class="add-food-input"
          [(ngModel)]="newFoodPhrase"
          (keydown)="onAddFoodKeyDown($event)"
          (blur)="onAddFoodBlur($event)"
          placeholder="What did you eat?"
          (input)="autoResizeTextarea($any($event.target))">
        </textarea>
        <button 
          class="send-button"
          (click)="sendNewFood()"
          (mousedown)="$event.preventDefault()"
          [disabled]="!newFoodPhrase || !newFoodPhrase.trim()">
          <ion-icon name="send" *ngIf="!isSubmittingNewFood"></ion-icon>
          <div *ngIf="isSubmittingNewFood" class="loading-dots">...</div>
        </button>
      </div>
    </div>
  </div>

  </div> <!-- End normal content -->

  <!-- Action/status footer -->
  <div class="confirm-section">
    <div *ngIf="(isSubmitting || isCanceling) && !isReadOnly" class="typing-indicator">
      <div class="typing-indicator-dots">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
    </div>

    <div *ngIf="!isSubmitting && !isCanceling && isReadOnly" class="status-text">{{ statusText }}    </div>
    <ion-button 
      *ngIf="!isSubmitting && !isCanceling && !isReadOnly"
      expand="block" 
      [disabled]="!isSelectionComplete()"
      (click)="confirmSelections()"
      color="tertiary"
      class="confirm-button">
      {{ isEditMode ? 'Confirm Edit' : 'Confirm Selection' }}
    </ion-button>

    <ion-button 
      *ngIf="!isSubmitting && !isCanceling && !isReadOnly"
      expand="block" 
      (click)="cancelSelection()"
      fill="outline"
      class="cancel-button">
      Cancel
    </ion-button>

    
  

    
  </div>
</div>
