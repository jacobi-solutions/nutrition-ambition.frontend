<div class="food-selection-container" [class.read-only]="isReadOnly">
  <div class="food-selection-container-inner">

    <!-- Normal content -->
      <!-- Food items list -->
      <div *ngIf="hasPayload" class="card-header">
        <label><strong>{{ ((message.mealName && message.mealName.trim().length > 0) ? message.mealName : 'Food Entry') | titlecase }}</strong></label>
        <div *ngIf="mealMacroSummary" class="meal-macro-summary">{{ mealMacroSummary }}</div>
      </div>

      <!-- Meal selection thinking dots (Stage 0) - only show when NO foods exist yet -->
      <div *ngIf="hasPayload && message.mealSelectionIsPending && computedFoods.length === 0" class="meal-thinking-indicator">
        <div class="analyzing-text">{{ message.text || 'Analyzing food entry' }}</div>
        <div class="typing-indicator-dots">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>

      <div *ngIf="hasPayload && computedFoods.length > 0" class="food-items-list">
      <!-- Loop over foods using new intermediate food component -->
      <ng-container *ngFor="let food of computedFoods; let foodIndex = index; let isLast = last; trackBy: trackByFood">
        <div class="food-item-container" [class.is-last]="isLast">
          <app-food
            [food]="food"
            [foodIndex]="foodIndex"
            [isReadOnly]="isReadOnly"
            [isEditMode]="isEditMode"
            (foodChanged)="onFoodChanged($event.index, $event.food)"
            (actionRequested)="onFoodActionRequested($event)">
          </app-food>
        </div>
      </ng-container>
    </div>

    <!-- Add more food section -->
    <div *ngIf="hasPayload && !isReadOnly && !isEditMode && !hasAnyPending && !isSubmitting" class="add-more-food-section">

      <!-- Initial "Add another food" button -->
      <div *ngIf="!showAddInput" class="add-something-display" (click)="showAddInput = true">
        <div class="add-something-text">Add another food</div>
        <ion-icon name="add-circle-outline" class="add-something-icon"></ion-icon>
      </div>

      <!-- Input with mode selector icons -->
      <div *ngIf="showAddInput" class="add-food-input-container">
        <!-- Mode selector icons -->
        <div class="mode-selector">
          <div
            class="mode-icon"
            [class.active]="addFoodMode === 'default'"
            (click)="setAddFoodMode('default')">
            <ion-icon name="sparkles"></ion-icon>
          </div>
          <div
            class="mode-icon"
            [class.active]="addFoodMode === 'quick'"
            (click)="setAddFoodMode('quick')">
            <ion-icon name="search"></ion-icon>
          </div>
          <div
            class="mode-icon disabled"
            [class.active]="addFoodMode === 'barcode'"
            (click)="setAddFoodMode('barcode')">
            <ion-icon name="barcode"></ion-icon>
          </div>
          <div class="spacer"></div>
          <div
            class="mode-icon close-icon"
            (click)="cancelAddFood()">
            <ion-icon name="close-outline"></ion-icon>
          </div>
        </div>

        <!-- Text input (uses existing search-food component) -->
        <app-search-food
          [placeholder]="getPlaceholderText()"
          [mode]="addFoodMode === 'barcode' ? 'default' : addFoodMode"
          [searchResults]="quickSearchResults"
          [isSearching]="isQuickSearching"
          (phraseSubmitted)="onAddFoodSubmitted($event)"
          (instantSearch)="onInstantSearch($event)"
          (resultSelected)="onQuickSearchResultSelected($event)"
          (editCanceled)="cancelAddFood()">
        </app-search-food>
      </div>
    </div>
  </div>


  <!-- Action/status footer -->
  <app-food-selection-actions
    [isSubmitting]="isSubmitting"
    [isCanceling]="isCanceling"
    [isReadOnly]="isReadOnly"
    [isEditMode]="isEditMode"
    [isLoading]="message.isPartial || hasAnyPending"
    [mealSelectionIsPending]="message.mealSelectionIsPending || false"
    [statusText]="statusText"
    (confirmSelection)="confirmSelections()"
    (cancelSelection)="cancelSelection()">
  </app-food-selection-actions>
</div>
