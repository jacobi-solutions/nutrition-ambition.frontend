<div class="food-selection-container">
  <div class="food-selection-container-inner">
    <!-- Food items list -->
    <div *ngIf="hasPayload" class="card-header">
      <label><strong>Food Items</strong></label>
    </div>
    
    <div *ngIf="hasPayload" class="food-items-list">
      <ng-container *ngFor="let phrase of payloadKeys">
        <!-- Compact food item row -->
        <div class="food-item-row-simple">
          <div class="breakdown-item">
            <div class="primary-info">
              <div class="name-section">
                <span class="name">{{ getSelectedFood(phrase)?.displayName }}</span>
                <span *ngIf="getSelectedFood(phrase)?.brandName" class="brand-name">
                  – {{ getSelectedFood(phrase)?.brandName }}
                </span>
                <!-- Inline quantity for read-only (CompletedFoodSelection) -->
                <span class="inline-amount" *ngIf="isReadOnly">
                  <ng-container *ngIf="getSelectedFood(phrase)?.scaledQuantity && getSelectedFood(phrase)?.scaledUnit; else fallbackServingInline">
                    ({{ getSelectedFood(phrase)?.scaledQuantity | number:'1.0-2' }} {{ getSelectedFood(phrase)?.scaledUnit }})
                  </ng-container>
                  <ng-template #fallbackServingInline>
                    <ng-container *ngIf="getSelectedServing(phrase)?.quantity && getSelectedServing(phrase)?.unit">
                      ({{ getSelectedServing(phrase)?.quantity | number:'1.0-2' }} {{ getSelectedServing(phrase)?.unit }})
                    </ng-container>
                  </ng-template>
                </span>
              </div>
              <div *ngIf="!isReadOnly && getSelectedServing(phrase)?.quantity && getSelectedServing(phrase)?.unit" class="amount">
                <ng-container *ngIf="getSelectedServing(phrase) as selectedServing">
                  <ng-container *ngIf="selectedServing.weightGramsPerUnit && isWeightUnit(selectedServing.unit); else simpleServing">
                    {{ (selectedServing.quantity! * selectedServing.weightGramsPerUnit) | number:'1.0-0' }}g
                  </ng-container>
                  <ng-template #simpleServing>
                    {{ selectedServing.quantity | number:'1.0-2' }} {{ selectedServing.unit }}
                  </ng-template>
                </ng-container>
              </div>
            </div>
          </div>
          <ion-icon 
            *ngIf="!isReadOnly"
            [name]="isExpanded(phrase) ? 'chevron-up-outline' : 'create-outline'" 
            class="edit-icon" 
            [class.expanded]="isExpanded(phrase)"
            (click)="toggleExpansion(phrase)">
          </ion-icon>
        </div>
        
              <!-- Expanded selection card for this specific food item -->
      <div *ngIf="isExpanded(phrase)" class="expanded-food-selection">
        <div class="drilldown-content">
          <div class="food-item-row">
            
            <!-- Food name and brand -->
            <div class="food-name">
              <label for="foodSelect-{{ phrase }}"><strong>{{ phrase }}</strong></label>
              <ion-select 
                interface="popover"
                [value]="getSelectedFood(phrase)?.fatSecretFoodId" 
                (ionChange)="onFoodSelected(phrase, $event.detail.value)" 
                [disabled]="isReadOnly"
                id="foodSelect-{{ phrase }}">
                <ion-select-option 
                  *ngFor="let food of (foodOptions?.[phrase] || [])" 
                  [value]="food.fatSecretFoodId">
                  {{ food.displayName }}
                  <span *ngIf="food.brandName"> – {{ food.brandName }}</span>
                </ion-select-option>
              </ion-select>
            </div>

            <!-- Inline radio buttons for serving options -->
            <div class="serving-options-inline">
              <ion-radio-group 
                [value]="getSelectedServingId(phrase)"
                (ionChange)="onServingSelected(phrase, $event.detail.value)">
                
                <ion-radio 
                  *ngFor="let serving of getSelectedFood(phrase)?.servings"
                  [value]="serving.fatSecretServingId"
                  [disabled]="isReadOnly">
                  <span *ngIf="serving.quantity && serving.unit">
                    {{ serving.quantity | number:'1.0-2' }} {{ serving.unit }}
                  </span>
                </ion-radio>
              </ion-radio-group>
            </div>

          </div>
        </div>
      </div>
      </ng-container>
    </div>

  </div>

  <!-- Confirm button -->
  <div *ngIf="!isReadOnly" class="confirm-section">
    <!-- Dots while submitting -->
    <div *ngIf="isSubmitting" class="typing-indicator bot-message-container">
      <div class="typing-indicator-dots">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
    </div>

    <!-- Confirm button -->
    <ion-button 
      *ngIf="!isSubmitting"
      expand="block" 
      [disabled]="!isSelectionComplete()"
      (click)="confirmSelections()"
      color="tertiary"
      class="confirm-button">
      Confirm Selection
    </ion-button>
  </div>

</div>
