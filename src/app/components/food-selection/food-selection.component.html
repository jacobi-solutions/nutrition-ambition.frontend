<div class="food-selection-container" [class.read-only]="isReadOnly">
  <div class="food-selection-container-inner">
    
    <!-- Normal content -->
      <!-- Food items list -->
      <div *ngIf="hasPayload" class="card-header">
        <label><strong>{{ ((message.mealName && message.mealName.trim().length > 0) ? message.mealName : 'Food Items') | titlecase }}</strong></label>
      </div>

      <div *ngIf="hasPayload" class="food-items-list">
      <!-- Loop over foods instead of flattened components -->
      <ng-container *ngFor="let food of (message.logMealToolResponse?.foods || []); let foodIndex = index; let isLast = last; trackBy: trackByFood">
        <div class="food-item-container" [class.is-last]="isLast" *ngIf="getComponentsForFood(food).length > 0">
          
          <!-- Cache components per food to avoid repeated calls -->
          <ng-container *ngIf="getComponentsForFood(food) as foodComponents">
          <!-- Multi-component food: Show as component-style item -->
          <ng-container *ngIf="foodComponents.length > 1">
            <!-- Food header component -->
            <app-food-header
              [food]="food"
              [foodIndex]="foodIndex"
              [isReadOnly]="isReadOnly"
              [isExpanded]="getComputedIsFoodEditingExpanded(foodIndex)"
              [currentQuantity]="editingFoodQuantities[foodIndex] || food.quantity || 1"
              (toggleExpansion)="toggleFoodEditing($event)"
              (quantityChanged)="onFoodQuantityChange($event.foodIndex, $event.quantity)"
              (removeFood)="removeFood($event)">
            </app-food-header>

            <!-- Expanded food editing (quantity + components) -->
            <div *ngIf="!isReadOnly && getComputedIsFoodEditingExpanded(foodIndex)" class="expanded-food-components">
            <ng-container *ngFor="let componentData of foodComponents; trackBy: trackByComponentId">
              <app-food-component-item
                [component]="componentData"
                [componentIndex]="0"
                [isReadOnly]="isReadOnly"
                [isEditMode]="isEditMode"
                [isExpanded]="expandedSections[componentData.componentId]"
                [isEditing]="componentData.component.isEditing || false"
                [editingValue]="componentData.component.editingValue || ''"
                [isSearching]="componentData.component.isSearching || false"
                [showingMoreOptions]="showingMoreOptionsFor[componentData.componentId]"
                [loadingMoreOptions]="loadingMoreOptionsFor[componentData.componentId]"
                [moreOptions]="moreOptionsFor[componentData.componentId] || []"
                [loadingInstantOptions]="loadingInstantOptionsFor[componentData.componentId]"
                (toggleExpansion)="toggleExpansion($event)"
                (servingSelected)="onServingSelected($event.componentId, $event.servingId)"
                (quantityChanged)="handleQuantityChange($event)"
                (editStarted)="startEditingComponent($event)"
                (editCanceled)="cancelEditingComponent($event)"
                (editConfirmed)="sendUpdatedComponent($event.componentId)"
                (removeComponent)="removeItem($event)"
                (moreOptionsRequested)="toggleMoreOptions($event)"
                (foodSelected)="handleFoodSelected($event)"
                (instantOptionsRequested)="onDropdownWillOpen($event.componentId)">
              </app-food-component-item>
            </ng-container>
            
          </div> <!-- Close expanded-food-components -->
          </ng-container> <!-- Close multi-component food -->

          <!-- Single-component food: Display using child component -->
          <ng-container *ngIf="foodComponents.length === 1">
            <ng-container *ngFor="let componentData of foodComponents; trackBy: trackByComponentId">
              <app-food-component-item
                [component]="componentData"
                [componentIndex]="0"
                [isReadOnly]="isReadOnly"
                [isEditMode]="isEditMode"
                [isExpanded]="expandedSections[componentData.componentId]"
                [isEditing]="componentData.component.isEditing || false"
                [editingValue]="componentData.component.editingValue || ''"
                [isSearching]="componentData.component.isSearching || false"
                [showingMoreOptions]="showingMoreOptionsFor[componentData.componentId]"
                [loadingMoreOptions]="loadingMoreOptionsFor[componentData.componentId]"
                [moreOptions]="moreOptionsFor[componentData.componentId] || []"
                [loadingInstantOptions]="loadingInstantOptionsFor[componentData.componentId]"
                (toggleExpansion)="toggleExpansion($event)"
                (servingSelected)="onServingSelected($event.componentId, $event.servingId)"
                (quantityChanged)="handleQuantityChange($event)"
                (editStarted)="startEditingComponent($event)"
                (editCanceled)="cancelEditingComponent($event)"
                (editConfirmed)="sendUpdatedComponent($event.componentId)"
                (removeComponent)="removeItem($event)"
                (moreOptionsRequested)="toggleMoreOptions($event)"
                (foodSelected)="handleFoodSelected($event)"
                (instantOptionsRequested)="onDropdownWillOpen($event.componentId)">
              </app-food-component-item>
            </ng-container>
          </ng-container> <!-- Close single-component food -->
          </ng-container> <!-- Close cached components container -->

        </div> <!-- Close food-item-container -->
      </ng-container>
    </div>

    <!-- Add something row -->
    <app-add-food
      [hasPayload]="hasPayload"
      [isReadOnly]="isReadOnly"
      [isEditMode]="isEditMode"
      (foodAdded)="onFoodAdded($event)">
    </app-add-food>
  </div>


  <!-- Action/status footer -->
  <app-food-selection-actions
    [isSubmitting]="isSubmitting"
    [isCanceling]="isCanceling"
    [isReadOnly]="isReadOnly"
    [isEditMode]="isEditMode"
    [statusText]="statusText"
    [isSelectionComplete]="isSelectionComplete()"
    (confirmSelection)="confirmSelections()"
    (cancelSelection)="cancelSelection()">
  </app-food-selection-actions>
</div>
