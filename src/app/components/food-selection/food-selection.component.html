<div class="food-selection-container" [class.read-only]="isReadOnly">
  <div class="food-selection-container-inner">

    <!-- Normal content -->
      <!-- Food items list -->
      <div *ngIf="hasPayload" class="card-header">
        <label><strong>{{ ((message.mealName && message.mealName.trim().length > 0) ? message.mealName : 'Food Entry') | titlecase }}</strong></label>
      </div>

      <!-- Meal selection thinking dots (Stage 0) -->
      <div *ngIf="hasPayload && message.mealSelectionIsPending" class="meal-thinking-indicator">
        <div class="analyzing-text">{{ message.text || 'Analyzing food entry' }}</div>
        <div class="typing-indicator-dots">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>

      <div *ngIf="hasPayload && !message.mealSelectionIsPending" class="food-items-list">
      <!-- Loop over foods using new intermediate food component -->
      <ng-container *ngFor="let food of computedFoods; let foodIndex = index; let isLast = last; trackBy: trackByFood">
        <div class="food-item-container" [class.is-last]="isLast">
          <app-food
            [food]="food"
            [foodIndex]="foodIndex"
            [isReadOnly]="isReadOnly"
            [isEditMode]="isEditMode"
            (foodChanged)="onFoodChanged($event.index, $event.food)"
            (actionRequested)="onFoodActionRequested($event)">
          </app-food>
        </div>
      </ng-container>
    </div>

    <!-- Add something row -->
    <div *ngIf="hasPayload && !isReadOnly && !isEditMode && !hasAnyPending" class="add-something-row">
      <div *ngIf="!isAddingFood" class="add-something-display" (click)="startAddingFood()">
        <div class="add-something-text">Add another food</div>
        <ion-icon name="add-circle-outline" class="add-something-icon"></ion-icon>
      </div>

      <app-search-food
        *ngIf="isAddingFood"
        placeholder="What did you eat?"
        (phraseSubmitted)="onFoodAdded($event)"
        (editCanceled)="cancelAddingFood()">
      </app-search-food>
    </div>
  </div>


  <!-- Action/status footer -->
  <app-food-selection-actions
    [isSubmitting]="isSubmitting"
    [isCanceling]="isCanceling"
    [isReadOnly]="isReadOnly"
    [isEditMode]="isEditMode"
    [isLoading]="message.isPartial || hasAnyPending"
    [mealSelectionIsPending]="message.mealSelectionIsPending || false"
    [statusText]="statusText"
    (confirmSelection)="confirmSelections()"
    (cancelSelection)="cancelSelection()">
  </app-food-selection-actions>
</div>
