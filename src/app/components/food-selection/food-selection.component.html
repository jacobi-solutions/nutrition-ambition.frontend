<div class="food-selection-container" [class.read-only]="isReadOnly">
  <div class="food-selection-container-inner">

    <!-- Streaming status banner -->
    <div *ngIf="message.isPartial && message.processingStage" class="streaming-banner">
      <div class="streaming-indicator">
        <ion-spinner name="dots" class="streaming-spinner"></ion-spinner>
        <span class="streaming-text">{{ message.text || 'Processing...' }}</span>
      </div>
    </div>

    <!-- Normal content -->
      <!-- Food items list -->
      <div *ngIf="hasPayload" class="card-header">
        <label><strong>{{ ((message.mealName && message.mealName.trim().length > 0) ? message.mealName : 'Food Items') | titlecase }}</strong></label>
      </div>

      <div *ngIf="hasPayload" class="food-items-list">
      <!-- Loop over foods using new intermediate food component -->
      <ng-container *ngFor="let food of computedFoods; let foodIndex = index; let isLast = last; trackBy: trackByFood">
        <div class="food-item-container" [class.is-last]="isLast">
          <app-food
            [food]="food"
            [foodIndex]="foodIndex"
            [isReadOnly]="isReadOnly"
            [isEditMode]="isEditMode"
            (foodChanged)="onFoodChanged($event.index, $event.food)"
            (actionRequested)="onFoodActionRequested($event)">
          </app-food>
        </div>
      </ng-container>
    </div>

    <!-- Add something row -->
    <div *ngIf="hasPayload && !isReadOnly && !isEditMode" class="add-something-row">
      <div *ngIf="!isAddingFood" class="add-something-display" (click)="startAddingFood()">
        <div class="add-something-text">Add another food</div>
        <ion-icon name="add-circle-outline" class="add-something-icon"></ion-icon>
      </div>

      <app-search-food
        *ngIf="isAddingFood"
        placeholder="What did you eat?"
        (phraseSubmitted)="onFoodAdded($event)"
        (editCanceled)="cancelAddingFood()">
      </app-search-food>
    </div>
  </div>


  <!-- Action/status footer -->
  <app-food-selection-actions
    [isSubmitting]="isSubmitting"
    [isCanceling]="isCanceling"
    [isReadOnly]="isReadOnly"
    [isEditMode]="isEditMode"
    [statusText]="statusText"
    (confirmSelection)="confirmSelections()"
    (cancelSelection)="cancelSelection()">
  </app-food-selection-actions>
</div>
