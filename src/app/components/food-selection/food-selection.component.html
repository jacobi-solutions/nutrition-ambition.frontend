<div class="food-selection-container" [class.read-only]="isReadOnly">
  <!-- Share button (only show when read-only/completed) - positioned absolutely in top right of entire card -->
  <ion-button
    *ngIf="isReadOnly && message.mealSelection?.foodEntryId"
    fill="clear"
    size="small"
    class="share-btn"
    (click)="onShareMeal($event)"
    type="button">
    <ion-icon slot="icon-only" name="share-outline"></ion-icon>
  </ion-button>

  <div class="food-selection-container-inner">

    <!-- Normal content -->
      <!-- Food items list -->
      <div *ngIf="hasPayload" class="card-header">
        <!-- Non-editing state: Click to edit -->
        <label *ngIf="!isEditingMealName" (click)="startEditingMealName()" [class.editable]="!isReadOnly">
          <strong>{{ ((message.mealName && message.mealName.trim().length > 0) ? message.mealName : 'Food Entry') | titlecase }}</strong>
        </label>

        <!-- Editing state: Input field -->
        <input
          #mealNameInput
          *ngIf="isEditingMealName"
          type="text"
          class="meal-name-input"
          [(ngModel)]="editingMealNameValue"
          (blur)="saveMealName()"
          (keyup.enter)="saveMealName()"
          (keyup.escape)="cancelEditingMealName()"
          placeholder="Enter meal name"
          autocapitalize="words"
        />

        <div *ngIf="mealMacroSummary" class="meal-macro-summary">{{ mealMacroSummary }}</div>
      </div>

      <!-- Meal selection thinking dots (Stage 0) - only show when NO foods exist yet -->
      <div *ngIf="hasPayload && message.mealSelectionIsPending && computedFoods.length === 0" class="meal-thinking-indicator">
        <div class="analyzing-text">{{ message.text || 'Analyzing food entry' }}</div>
        <div class="typing-indicator-dots">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>

      <div *ngIf="hasPayload && computedFoods.length > 0" class="food-items-list">
      <!-- Loop over foods using new intermediate food component -->
      <ng-container *ngFor="let food of computedFoods; let foodIndex = index; let isLast = last; trackBy: trackByFood">
        <div class="food-item-container" [class.is-last]="isLast">
          <app-food
            [food]="food"
            [foodIndex]="foodIndex"
            [isReadOnly]="isReadOnly"
            [isEditMode]="isEditMode"
            (foodChanged)="onFoodChanged($event.index, $event.food)"
            (actionRequested)="onFoodActionRequested($event)">
          </app-food>
        </div>
      </ng-container>
    </div>

    <!-- Add more food section -->
    <div *ngIf="hasPayload && !isReadOnly && !hasAnyPending && !isSubmitting" class="add-more-food-section">
      <!-- Input with mode selector icons - always shown -->
      <div class="add-food-input-container">
        <!-- Header text - only show if foods already exist -->
        <div *ngIf="computedFoods.length === 0" class="add-food-header">Add first food</div>
        <div *ngIf="computedFoods.length > 0" class="add-food-header">Add another food</div>

        <!-- Mode selector icons -->
        <div class="mode-selector">
          <div
            class="mode-icon"
            [class.active]="addFoodMode === 'default'"
            (click)="setAddFoodMode('default')">
            <ion-icon name="sparkles"></ion-icon>
          </div>

          <!-- Only show star if favorites exist and finished loading -->
          <div
            *ngIf="shouldShowFavoritesStar"
            class="mode-icon"
            [class.active]="addFoodMode === 'favorites'"
            (click)="setAddFoodMode('favorites')">
            <ion-icon name="star"></ion-icon>
          </div>

          <div
            class="mode-icon"
            [class.active]="addFoodMode === 'quick'"
            (click)="setAddFoodMode('quick')">
            <ion-icon name="search"></ion-icon>
          </div>
          <div
            class="mode-icon disabled"
            [class.active]="addFoodMode === 'barcode'"
            (click)="setAddFoodMode('barcode')">
            <ion-icon name="barcode"></ion-icon>
          </div>
        </div>

        <!-- Unified search component (handles quick search, favorites, and default modes) -->
        <app-search-food
          [placeholder]="getPlaceholderText()"
          [mode]="addFoodMode === 'barcode' ? 'default' : addFoodMode"
          [searchResults]="quickSearchResults"
          [favoritesData]="favorites"
          [isSearching]="isQuickSearching"
          (phraseSubmitted)="onAddFoodSubmitted($event)"
          (instantSearch)="onInstantSearch($event)"
          (resultSelected)="handleResultSelected($event)"
          (editCanceled)="cancelAddFood()">
        </app-search-food>
      </div>
    </div>
  </div>


  <!-- Action/status footer -->
  <app-food-selection-actions
    [isSubmitting]="isSubmitting"
    [isCanceling]="isCanceling"
    [isReadOnly]="isReadOnly"
    [isEditMode]="isEditMode"
    [isLoading]="message.isPartial || hasAnyPending"
    [mealSelectionIsPending]="message.mealSelectionIsPending || false"
    [statusText]="statusText"
    (confirmSelection)="confirmSelections()"
    (cancelSelection)="cancelSelection()">
  </app-food-selection-actions>
</div>
