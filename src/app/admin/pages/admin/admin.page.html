<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Admin Panel</ion-title>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/app/chat"></ion-back-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Admin Panel</ion-title>
    </ion-toolbar>
  </ion-header>
  

  <div class="admin-layout">
    <!-- Desktop Sidebar Navigation -->
    <div class="admin-sidebar">
      <div class="sidebar-nav">
        <button 
          class="nav-item" 
          [class.active]="currentView === 'overview'"
          (click)="currentView = 'overview'">
          <ion-icon name="analytics-outline"></ion-icon>
          <span>Dashboard Overview</span>
        </button>
        
        <button 
          class="nav-item" 
          [class.active]="currentView === 'feedback'"
          (click)="currentView = 'feedback'; loadFeedback()">
          <ion-icon name="chatbubbles-outline"></ion-icon>
          <span>Feedback Management</span>
          <ion-badge *ngIf="feedbackStats.incomplete > 0" color="warning" class="nav-badge">
            {{ feedbackStats.incomplete }}
          </ion-badge>
        </button>
        
        <button
          class="nav-item"
          [class.active]="currentView === 'accounts'"
          (click)="currentView = 'accounts'; loadAccounts()">
          <ion-icon name="person-outline"></ion-icon>
          <span>Account Management</span>
          <ion-badge *ngIf="accounts.length > 0" color="primary" class="nav-badge">
            {{ accounts.length }}
          </ion-badge>
        </button>

        <button
          class="nav-item"
          [class.active]="currentView === 'guidelines'"
          (click)="currentView = 'guidelines'; switchToGuidelines()">
          <ion-icon name="document-outline"></ion-icon>
          <span>Guideline Files</span>
          <ion-badge *ngIf="guidelineFiles.length > 0" color="secondary" class="nav-badge">
            {{ guidelineFiles.length }}
          </ion-badge>
        </button>
      </div>

      <!-- Mobile Navigation (fallback) -->
      <ion-segment [(ngModel)]="currentView" (ionChange)="onViewChange($event)" class="mobile-nav">
        <ion-segment-button value="overview">
          <ion-label>Overview</ion-label>
          <ion-icon name="analytics-outline"></ion-icon>
        </ion-segment-button>
        <ion-segment-button value="feedback">
          <ion-label>Feedback</ion-label>
          <ion-icon name="chatbubbles-outline"></ion-icon>
          <ion-badge *ngIf="feedbackStats.incomplete > 0" color="warning">{{ feedbackStats.incomplete }}</ion-badge>
        </ion-segment-button>
        <ion-segment-button value="accounts">
          <ion-label>Accounts</ion-label>
          <ion-icon name="person-outline"></ion-icon>
        </ion-segment-button>
        <ion-segment-button value="guidelines">
          <ion-label>Guidelines</ion-label>
          <ion-icon name="document-outline"></ion-icon>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Main Content Area -->
    <div class="admin-main">
      <!-- Overview View -->
      <div *ngIf="currentView === 'overview'" class="overview-content">
        <div class="page-header">
          <h1>Dashboard Overview</h1>
          <p>System statistics and account information</p>
        </div>

        <div class="overview-grid">
          <!-- Account Information -->
          <div class="info-section">
            <div class="section-header">
              <h2>Account Information</h2>
              <ion-icon name="person-outline"></ion-icon>
            </div>
            
            <div class="info-content" *ngIf="account; else noAccount">
              <div class="info-grid">
                <div class="info-item">
                  <label>Name</label>
                  <span>{{ account.name || 'Not set' }}</span>
                </div>
                
                <div class="info-item">
                  <label>Email</label>
                  <span>{{ account.email || 'Not set' }}</span>
                </div>
                
                <div class="info-item">
                  <label>Account ID</label>
                  <span class="account-id">{{ account.id }}</span>
                </div>
                
                <div class="info-item">
                  <label>Owner Status</label>
                  <ion-badge color="{{ account.isOwner ? 'success' : 'medium' }}">
                    {{ account.isOwner ? 'Owner' : 'Regular User' }}
                  </ion-badge>
                </div>
                
                <div class="info-item">
                  <label>Time Zone</label>
                  <span>{{ account.timeZoneId || 'Not set' }}</span>
                </div>
              </div>
            </div>
            
            <ng-template #noAccount>
              <div class="loading-placeholder">
                <ion-spinner color="primary"></ion-spinner>
                <p>Loading account information...</p>
              </div>
            </ng-template>
          </div>

          <!-- Feedback Statistics -->
          <div class="stats-section">
            <div class="section-header">
              <h2>Feedback Statistics</h2>
              <ion-icon name="bar-chart-outline"></ion-icon>
            </div>
            
            <div class="stats-content">
              <!-- Main Stats -->
              <div class="main-stats">
                <div class="stat-card primary">
                  <div class="stat-number">{{ feedbackStats.total }}</div>
                  <div class="stat-label">Total Feedback</div>
                </div>
                
                <div class="stat-card warning">
                  <div class="stat-number">{{ feedbackStats.incomplete }}</div>
                  <div class="stat-label">Pending Review</div>
                </div>
                
                <div class="stat-card success">
                  <div class="stat-number">{{ feedbackStats.completed }}</div>
                  <div class="stat-label">Completed</div>
                </div>
                
                <div class="stat-card secondary">
                  <div class="stat-number">
                    {{ feedbackStats.total > 0 ? ((feedbackStats.completed / feedbackStats.total) * 100).toFixed(0) : 0 }}%
                  </div>
                  <div class="stat-label">Completion Rate</div>
                </div>
              </div>

              <!-- Type Breakdown -->
              <div *ngIf="statsEntries.length > 0" class="type-breakdown">
                <h3>Breakdown by Type</h3>
                <div class="type-stats-grid">
                  <div *ngFor="let stat of statsEntries" class="type-stat-card">
                    <ion-icon [name]="getTypeIcon(stat.key)" [color]="getTypeColor(stat.key)"></ion-icon>
                    <div class="type-info">
                      <span class="type-name">{{ stat.key | titlecase }}</span>
                      <span class="type-count">{{ stat.value }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <ion-button expand="block" fill="outline" (click)="switchToFeedback()" class="action-button">
                <ion-icon name="eye-outline" slot="start"></ion-icon>
                View All Feedback
              </ion-button>
            </div>
          </div>
        </div>
      </div>

      <!-- Feedback Management View -->
      <div *ngIf="currentView === 'feedback'" class="feedback-content">
        <div class="page-header">
          <h1>Feedback Management</h1>
          <p>Review and manage user feedback entries</p>
        </div>

        <!-- Filters and Controls -->
        <div class="feedback-controls">
          <div class="filters">
            <div class="filter-group">
              <label>Type</label>
              <ion-select
                [(ngModel)]="selectedFilterType"
                (ionChange)="onFilterTypeChange()"
                placeholder="Filter by type"
                interface="popover">
                <ion-select-option value="all">All Types</ion-select-option>
                <ion-select-option *ngFor="let type of feedbackTypes" [value]="type">
                  {{ type | titlecase }}
                </ion-select-option>
              </ion-select>
            </div>
            
            <div class="filter-group">
              <label>Status</label>
              <ion-select
                [(ngModel)]="selectedCompletionFilter"
                (ionChange)="onCompletionFilterChange()"
                placeholder="Filter by status"
                interface="popover">
                <ion-select-option value="all">All Status</ion-select-option>
                <ion-select-option value="completed">Completed</ion-select-option>
                <ion-select-option value="incomplete">Incomplete</ion-select-option>
              </ion-select>
            </div>

            <div class="filter-group">
              <label>User Email</label>
              <ion-input
                [(ngModel)]="userEmailFilter"
                (ionInput)="onUserEmailFilterChange()"
                placeholder="Filter by user email"
                clearInput="true"
                type="email">
              </ion-input>
            </div>

            <div class="filter-group">
              <label>App Version</label>
              <ion-select
                [(ngModel)]="selectedVersionFilter"
                (ionChange)="onVersionFilterChange()"
                placeholder="Filter by app version"
                interface="popover">
                <ion-select-option value="all">All Versions</ion-select-option>
                <ion-select-option *ngFor="let version of uniqueAppVersions" [value]="version">
                  v{{ version }}
                </ion-select-option>
              </ion-select>
            </div>
          </div>

          <ion-button fill="outline" (click)="loadFeedback()" class="refresh-button">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            Refresh
          </ion-button>
        </div>

        <!-- Results Summary -->
        <div class="results-summary" *ngIf="!isLoading">
          <span>Showing {{ filteredFeedbackEntries.length }} of {{ feedbackEntries.length }} entries</span>
        </div>

        <!-- Loading State -->
        <div *ngIf="isLoading" class="loading-container">
          <ion-spinner color="primary"></ion-spinner>
          <p>Loading feedback entries...</p>
        </div>

        <!-- Feedback Entries -->
        <div *ngIf="!isLoading" class="feedback-list">
          <!-- Empty States -->
          <div *ngIf="filteredFeedbackEntries.length === 0 && feedbackEntries.length === 0" class="empty-state">
            <ion-icon name="chatbubbles-outline" size="large"></ion-icon>
            <h3>No Feedback Yet</h3>
            <p>No feedback entries have been submitted by users.</p>
          </div>

          <div *ngIf="filteredFeedbackEntries.length === 0 && feedbackEntries.length > 0" class="empty-state">
            <ion-icon name="filter-outline" size="large"></ion-icon>
            <h3>No Results</h3>
            <p>No feedback entries match the current filters.</p>
          </div>

          <!-- Feedback Table -->
          <div class="feedback-table-container">
            <table class="feedback-table">
              <thead>
                <tr>
                  <th class="sortable-header" (click)="sortBy('type')">
                    Type
                    <ion-icon 
                      *ngIf="sortColumn === 'type'" 
                      [name]="sortDirection === 'asc' ? 'chevron-up-outline' : 'chevron-down-outline'"
                      class="sort-icon">
                    </ion-icon>
                  </th>
                  <th class="sortable-header" (click)="sortBy('status')">
                    Status
                    <ion-icon 
                      *ngIf="sortColumn === 'status'" 
                      [name]="sortDirection === 'asc' ? 'chevron-up-outline' : 'chevron-down-outline'"
                      class="sort-icon">
                    </ion-icon>
                  </th>
                  <th class="sortable-header" (click)="sortBy('email')">
                    User Email
                    <ion-icon 
                      *ngIf="sortColumn === 'email'" 
                      [name]="sortDirection === 'asc' ? 'chevron-up-outline' : 'chevron-down-outline'"
                      class="sort-icon">
                    </ion-icon>
                  </th>
                  <th>Message</th>
                  <th class="sortable-header" (click)="sortBy('date')">
                    Date
                    <ion-icon 
                      *ngIf="sortColumn === 'date'" 
                      [name]="sortDirection === 'asc' ? 'chevron-up-outline' : 'chevron-down-outline'"
                      class="sort-icon">
                    </ion-icon>
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let feedbackWithAccount of filteredFeedbackEntries" class="feedback-row">
                  <td>
                    <ion-badge [color]="getTypeColor(feedbackWithAccount.feedback?.feedbackType!)" class="type-badge">
                      <ion-icon [name]="getTypeIcon(feedbackWithAccount.feedback?.feedbackType!)"></ion-icon>
                      {{ feedbackWithAccount.feedback?.feedbackType | titlecase }}
                    </ion-badge>
                  </td>
                  <td>
                    <ion-badge [color]="feedbackWithAccount.feedback?.isCompleted ? 'success' : 'warning'" class="status-badge">
                      {{ feedbackWithAccount.feedback?.isCompleted ? 'Completed' : 'Pending' }}
                    </ion-badge>
                  </td>
                  <td class="email-cell">
                    {{ feedbackWithAccount.accountEmail || 'Unknown User' }}
                  </td>
                  <td class="message-cell">
                    {{ getShortenedMessage(feedbackWithAccount.feedback?.message) }}
                  </td>
                  <td class="date-cell">
                    {{ formatDate(feedbackWithAccount.feedback?.createdDateUtc?.toString()) }}
                  </td>
                  <td class="actions-cell">
                    <ion-button
                      size="small"
                      color="primary"
                      fill="outline"
                      (click)="viewUserContext(feedbackWithAccount)">
                      <ion-icon name="eye-outline" slot="start"></ion-icon>
                      View
                    </ion-button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Accounts View -->
      <div *ngIf="currentView === 'accounts'" class="accounts-content">
        <div class="page-header">
          <h1>Account Management</h1>
          <p>Manage user accounts and perform cascade deletions</p>
        </div>

        <div class="account-controls">
          <div class="stats-summary">
            <div class="stat-item">
              <span class="stat-label">Total Accounts</span>
              <span class="stat-value">{{ accounts.length }}</span>
            </div>
          </div>
          
          <div class="control-actions">
            <ion-button
              color="primary"
              fill="outline"
              (click)="loadAccounts()"
              [disabled]="isLoadingAccounts">
              <ion-icon name="refresh-outline" slot="start"></ion-icon>
              {{ isLoadingAccounts ? 'Loading...' : 'Refresh' }}
            </ion-button>
          </div>
        </div>

        <div *ngIf="accounts.length === 0 && !isLoadingAccounts" class="empty-state">
          <ion-icon name="people-outline" size="large"></ion-icon>
          <h3>No accounts found</h3>
          <p>There are no accounts in the system.</p>
        </div>

        <div *ngIf="isLoadingAccounts" class="loading-state">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Loading accounts...</p>
        </div>

        <!-- Accounts Table -->
        <div *ngIf="accounts.length > 0 && !isLoadingAccounts" class="accounts-table-container">
          <table class="accounts-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Type</th>
                <th>Timezone</th>
                <th>Data Count</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let account of accounts; trackBy: trackByAccountId">
                <!-- Main account row -->
                <tr class="account-row" 
                    [class.expanded]="isAccountExpanded(account)"
                    (click)="toggleAccountExpansion(account)">
                  <td class="account-name">
                    <div class="name-cell">
                      <strong>{{ account.name || 'Unnamed' }}</strong>
                      <small class="account-id">{{ account.id }}</small>
                    </div>
                  </td>
                  <td class="account-email">{{ account.email }}</td>
                  <td class="account-type">
                    <ion-chip 
                      [color]="account.isOwner ? 'success' : 'medium'" 
                      [outline]="!account.isOwner"
                      size="small">
                      <ion-icon 
                        [name]="account.isOwner ? 'shield-checkmark-outline' : 'person-outline'" 
                        slot="start">
                      </ion-icon>
                      {{ account.isOwner ? 'Owner' : 'User' }}
                    </ion-chip>
                  </td>
                  <td class="account-timezone">{{ account.timeZoneId || 'Not set' }}</td>
                  <td class="data-count">
                    <span *ngIf="getAccountCounts(account); else loadingOrUnknown" 
                          class="total-count">
                      {{ getAccountCounts(account).totalCount }}
                    </span>
                    <ng-template #loadingOrUnknown>
                      <ion-spinner *ngIf="isLoadingCounts(account)" name="dots" color="medium"></ion-spinner>
                      <span *ngIf="!isLoadingCounts(account)" class="unknown-count">â€”</span>
                    </ng-template>
                  </td>
                  <td class="actions-cell">
                    <ion-button
                      size="small"
                      color="warning"
                      fill="outline"
                      [disabled]="!account.canClear"
                      (click)="clearAccountData(account); $event.stopPropagation()">
                      <ion-icon name="refresh-outline" slot="start"></ion-icon>
                      {{ account.canClear ? 'Clear' : 'Protected' }}
                    </ion-button>
                    <ion-button
                      size="small"
                      color="danger"
                      fill="outline"
                      [disabled]="!account.canDelete"
                      (click)="deleteAccount(account); $event.stopPropagation()">
                      <ion-icon name="trash-outline" slot="start"></ion-icon>
                      {{ account.canDelete ? 'Delete' : 'Protected' }}
                    </ion-button>
                    <ion-button
                      size="small"
                      fill="clear"
                      color="medium">
                      <ion-icon
                        [name]="isAccountExpanded(account) ? 'chevron-up-outline' : 'chevron-down-outline'">
                      </ion-icon>
                    </ion-button>
                  </td>
                </tr>

                <!-- Expanded data breakdown row -->
                <tr *ngIf="isAccountExpanded(account)" class="expanded-row">
                  <td colspan="6" class="expanded-content">
                    <div *ngIf="isLoadingCounts(account)" class="loading-counts">
                      <ion-spinner name="crescent"></ion-spinner>
                      <span>Loading data breakdown...</span>
                    </div>
                    
                    <div *ngIf="!isLoadingCounts(account) && getAccountCounts(account)" class="data-breakdown">
                      <div class="breakdown-header">
                        <span class="breakdown-title">Data Breakdown</span>
                        <ion-chip color="primary" size="small">
                          Total: {{ getAccountCounts(account).totalCount }}
                        </ion-chip>
                      </div>
                      
                      <div class="breakdown-items" *ngIf="getAccountCounts(account).breakdown?.length > 0">
                        <div *ngFor="let item of getAccountCounts(account).breakdown" class="breakdown-item">
                          <ion-icon [name]="item.icon" color="medium"></ion-icon>
                          <span>{{ item.label }}</span>
                          <ion-badge color="medium">{{ item.count }}</ion-badge>
                        </div>
                      </div>
                      
                      <div *ngIf="getAccountCounts(account).breakdown?.length === 0" class="no-data-message">
                        <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
                        <span>No user data - safe to delete</span>
                      </div>
                      
                      <div class="warning-message" *ngIf="getAccountCounts(account).totalCount > 0">
                        <ion-icon name="warning-outline" color="warning"></ion-icon>
                        <span>Deleting will permanently remove {{ getAccountCounts(account).totalCount }} records</span>
                      </div>
                    </div>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Guidelines View -->
      <div *ngIf="currentView === 'guidelines'" class="guidelines-content">
        <div class="page-header">
          <h1>Guideline Files</h1>
          <p>Upload and manage guideline files for use with OpenAI Responses API</p>
        </div>

        <div class="guidelines-controls">
          <div class="control-actions">
            <input #fileInput type="file" style="display: none" accept=".txt,.md,.pdf,.js,.ts,.py,.json,.xml,.html,.css" (change)="onFileSelected($event)" />
            <ion-button color="primary" (click)="fileInput.click()" [disabled]="isUploadingFile">
              <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
              {{ isUploadingFile ? 'Uploading...' : 'Upload File' }}
            </ion-button>
            <ion-button color="medium" fill="outline" (click)="loadGuidelineFiles()" [disabled]="isLoadingGuidelineFiles">
              <ion-icon name="refresh-outline" slot="start"></ion-icon>
              Refresh
            </ion-button>
          </div>

          <!-- Upload Progress Bar -->
          <div *ngIf="isUploadingFile" class="upload-progress">
            <ion-progress-bar [value]="uploadProgress / 100" color="primary"></ion-progress-bar>
            <p class="progress-text">{{ uploadProgress }}%</p>
          </div>
        </div>

        <div *ngIf="isLoadingGuidelineFiles" class="loading-state">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Loading guideline files...</p>
        </div>

        <div *ngIf="!isLoadingGuidelineFiles && guidelineFiles.length === 0" class="empty-state">
          <ion-icon name="document-outline" size="large"></ion-icon>
          <h3>No Guideline Files</h3>
          <p>Upload your first guideline file to get started.</p>
        </div>

        <div *ngIf="!isLoadingGuidelineFiles && guidelineFiles.length > 0" class="guidelines-table-container">
          <table class="guidelines-table">
            <thead>
              <tr>
                <th>File Name</th>
                <th>Size</th>
                <th>Type</th>
                <th>Upload Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let file of guidelineFiles" class="guideline-row">
                <td class="file-name">
                  <ion-icon name="document-text-outline"></ion-icon>
                  {{ file.fileName }}
                </td>
                <td>{{ formatFileSize(file.fileSize) }}</td>
                <td>
                  <ion-chip size="small" color="medium">
                    {{ file.type }}
                  </ion-chip>
                </td>
                <td>{{ formatDate(file.createdDateUtc) }}</td>
                <td>
                  <ion-badge [color]="file.status === 'ready' ? 'success' : file.status === 'error' ? 'danger' : 'warning'">
                    {{ file.status | titlecase }}
                  </ion-badge>
                </td>
                <td class="actions-cell">
                  <ion-button size="small" color="danger" fill="outline" (click)="deleteGuidelineFile(file)">
                    <ion-icon name="trash-outline" slot="start"></ion-icon>
                    Delete
                  </ion-button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</ion-content> 