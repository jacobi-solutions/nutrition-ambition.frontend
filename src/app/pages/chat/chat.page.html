<app-header 
  [title]="'Chat'" 
  [showBackButton]="false" 
  [selectedDate]="selectedDate"
  (dateChanged)="onDateChanged($event)"
  (previousDay)="onPreviousDay()"
  (nextDay)="onNextDay()"
  (login)="onLogin()"
  (logout)="onLogout()"
  (refresh)="onRefresh()">
</app-header>

<ion-content [fullscreen]="true" [scrollEvents]="true" (ionScroll)="onScroll($event)" #content>
  <!-- Pull-to-refresh functionality -->
  <ion-refresher slot="fixed" (ionRefresh)="onRefresh($event)">
    <ion-refresher-content
      pullingText="Pull to refresh"
      refreshingSpinner="circles"
      refreshingText="Refreshing...">
    </ion-refresher-content>
  </ion-refresher>


  <div class="ion-padding">
    <div *ngIf="isLoadingHistory" class="loading-container">
      <ion-spinner name="circular"></ion-spinner>
    </div>

    <div *ngIf="error" class="error-message">
      {{ error }}
    </div>
    
    <div *ngIf="!isLoadingHistory && !error">
      <!-- Messages container -->
      <div class="chat-container">
        <!-- Loop through each message in chronological order and render appropriately -->
        <ng-container *ngFor="let message of messages; trackBy: trackMessage">
          <!-- Context note message with enhanced edit loading states -->
          <div *ngIf="message.isContextNote" class="context-note-inline">
            <div class="context-note-text">
              {{ message.text }}
            </div>
            
          </div>

          <!-- Standalone food selection cards for pending and completed selection messages -->
          <div *ngIf="!message.isContextNote && (message.role === MessageRoleTypes.PendingFoodSelection || message.role === MessageRoleTypes.CompletedFoodSelection || message.role === MessageRoleTypes.PendingEditFoodSelection || message.role === MessageRoleTypes.CompletedEditFoodSelection)" class="standalone-food-selection">
            <!-- Show card immediately when mealSelection exists, even if foods array is empty (for progressive loading) -->
            <app-food-selection
              *ngIf="message?.mealSelection"
              [message]="message"
              [isEditingPhrase]="message.isEditingPhrase || false"
              (selectionConfirmed)="onFoodSelectionConfirmed($event)"
              (editConfirmed)="onEditFoodSelectionConfirmed($event)"
              (selectionCanceled)="onCancelFoodSelection(message)"
              (updatedMessage)="onFoodPhraseUpdated($event)"
              (shareMeal)="onShareMeal(message)">
            </app-food-selection>

          </div>

          <!-- Regular chat message -->
          <app-chat-message
            *ngIf="!message.isContextNote && message.role !== MessageRoleTypes.PendingFoodSelection && message.role !== MessageRoleTypes.CompletedFoodSelection && message.role !== MessageRoleTypes.PendingEditFoodSelection && message.role !== MessageRoleTypes.CompletedEditFoodSelection"
            [text]="message.text"
            [isUser]="message.isUser"
            [timestamp]="message.timestamp"
            [role]="message.role"
            [isStreaming]="message.isStreaming || false">
          </app-chat-message>
        </ng-container>

        <!-- Typing indicator positioned where next message will appear (only before streaming starts) -->
        <div *ngIf="isLoading" class="typing-indicator bot-message-container">
          <div class="typing-indicator-dots">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
</ion-content>



<ion-footer class="chat-footer">
  
  <div class="fab-and-input">
    <!-- Custom Floating FAB -->
    <div class="manual-fab-wrapper">
      <button class="manual-fab-icon-button" [class.open]="isOpen" (click)="toggleFab()">
        <ion-icon [name]="isOpen ? 'close-circle-outline' : 'add-outline'"></ion-icon>
      </button>
      


      <div class="manual-fab-actions" *ngIf="isOpen">
        <button class="fab-action" title="Favorites" (click)="handleAction('favorites')">
          <ion-icon name="star"></ion-icon>
        </button>
        <button class="fab-action" title="Quick search" (click)="handleAction('quick-search')">
          <ion-icon name="search"></ion-icon>
        </button>
        <button class="fab-action" title="Scan barcode" (click)="handleAction('barcode')">
          <ion-icon name="barcode-sharp"></ion-icon>
        </button>
        <button class="fab-action" title="Take a photo" (click)="handleAction('photo')">
          <ion-icon name="camera"></ion-icon>
        </button>
      </div>
    </div>
    <!-- Chat input container -->
    <div class="input-group">
      <textarea
        #messageInput
        class="chat-text-input"
        placeholder="Type your message..."
        inputmode="text"
        enterkeyhint="enter"
        [(ngModel)]="userMessage"
        (keydown)="onKeyDown($event)"
        (input)="onTextareaInput($event)"
        [disabled]="isLoading"
        rows="1">
      </textarea>
      
    </div>
    <button
      class="send-btn"
      [disabled]="isLoading || !userMessage.trim() || isStreamingActive"
      (click)="sendMessage()"
      aria-label="Send message">
      <ion-icon name="paper-plane-sharp"></ion-icon>
    </button>
  </div>
</ion-footer> 