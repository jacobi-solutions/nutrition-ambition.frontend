<app-header 
  [title]="'Daily Summary'" 
  [showBackButton]="false" 
  [selectedDate]="selectedDate"
  (dateChanged)="onDateChanged($event)"
  (previousDay)="onPreviousDay()"
  (nextDay)="onNextDay()"
  (login)="onLogin()"
  (logout)="onLogout()"
  (refresh)="onRefresh()">
</app-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Pull-to-refresh functionality -->
  <ion-refresher slot="fixed" (ionRefresh)="onRefresh($event)">
    <ion-refresher-content
      pullingText="Pull to refresh"
      refreshingSpinner="circles"
      refreshingText="Refreshing...">
    </ion-refresher-content>
  </ion-refresher>

  <div class="main-content-wrapper">
    <div *ngIf="detailedLoading" class="loading-container">
      <ion-spinner name="circular"></ion-spinner>
    </div>

    <div *ngIf="detailedError" class="error-message">
      <ion-icon name="alert-circle-outline" class="error-icon"></ion-icon>
      <div class="error-text">
        {{ detailedError || 'An error occurred loading your nutrition data. Please try again later.' }}
      </div>
    </div>

    <div *ngIf="!detailedLoading && !detailedError">
      <ion-segment [(ngModel)]="viewMode" (ionChange)="segmentChanged($event)" class="segment-toggle">
        <ion-segment-button value="nutrients">
          <ion-label>Nutrients</ion-label>
        </ion-segment-button>
        <ion-segment-button value="foods">
          <ion-label>Foods</ion-label>
        </ion-segment-button>
      </ion-segment>

      <!-- Nutrients View -->
      <div *ngIf="viewMode === 'nutrients'" class="breakdown-container">
        <!-- Macronutrients Card -->
        <ion-card [class.expanded]="selectedNutrient">
          <ion-card-header>
            <ion-card-title>Macronutrients</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list [class.expanded]="selectedNutrient && isLastItem(selectedNutrient, macronutrientList)">
              <ng-container *ngFor="let nutrient of macronutrientList; trackBy: trackById">
                <ion-item 
                  class="nutrient-entry"
                  (click)="selectNutrient(nutrient)" 
                  [class.selected]="selectedNutrient?.nutrientKey === nutrient.nutrientKey">
                  <div class="breakdown-item">
                    <div class="primary-info">
                      <span class="name">{{ nutrient.nutrientName || nutrient.nutrientKey }}</span>
                      <span class="amount">{{ formatConsumedTarget(nutrient) }}</span>
                    </div>
                  </div>

                  <ion-button 
                    fill="clear" 
                    slot="end" 
                    size="small" 
                    class="action-btn" 
                    (click)="openActionMenu($event, nutrient, 'nutrient')">
                    <ion-icon name="ellipsis-vertical"></ion-icon>
                  </ion-button>

                  <ion-button 
                    fill="clear" 
                    slot="end" 
                    size="small" 
                    class="chevron-btn">
                    <ion-icon 
                      [name]="selectedNutrient?.nutrientKey === nutrient.nutrientKey ? 'chevron-down-outline' : 'chevron-forward-outline'">
                    </ion-icon>
                  </ion-button>
                </ion-item>

                <ng-container *ngIf="selectedNutrient?.nutrientKey === nutrient.nutrientKey">
                  <ion-item lines="none" class="drilldown-row nutrient-drilldown">
                    <div class="drilldown-content">
                      <ng-container *ngIf="selectedNutrient && selectedNutrient.foods?.length">
                        <ng-container *ngFor="let food of selectedNutrient.foods; trackBy: trackById">
                          <div class="detail-item clickable-food" (click)="food.name && navigateToFood(food.name)">
                            <span class="detail-name">
                              <span *ngIf="food.brandName" class="brand-name">{{ food.brandName }} - </span>{{ food.name }}
                            </span>
                            <span class="detail-amount">{{ formatAmountWithFoodUnit(food) }}</span>
                          </div>
                        </ng-container>
                      </ng-container>
                      <div *ngIf="selectedNutrient && !selectedNutrient.foods?.length" class="empty-detail-message">
                        <span>No foods logged for this nutrient yet.</span>
                      </div>
                    </div>
                  </ion-item>
                </ng-container>
                
                
              </ng-container>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <!-- Micronutrients Card -->
        <ion-card [class.expanded]="selectedNutrient">
          <ion-card-header>
            <ion-card-title>Micronutrients</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list [class.expanded]="selectedNutrient && isLastItem(selectedNutrient, micronutrientList)">
              <ng-container *ngFor="let nutrient of micronutrientList; trackBy: trackById">
                <ion-item 
                  class="nutrient-entry"
                  (click)="selectNutrient(nutrient)" 
                  [class.selected]="selectedNutrient?.nutrientKey === nutrient.nutrientKey">
                  <div class="breakdown-item">
                    <div class="primary-info">
                      <span class="name">{{ nutrient.nutrientName || nutrient.nutrientKey }}</span>
                      <span class="amount">{{ formatConsumedTarget(nutrient) }}</span>
                    </div>
                  </div>

                  <ion-button 
                    fill="clear" 
                    slot="end" 
                    size="small" 
                    class="action-btn" 
                    (click)="openActionMenu($event, nutrient, 'nutrient')">
                    <ion-icon name="ellipsis-vertical"></ion-icon>
                  </ion-button>

                  <ion-button 
                    fill="clear" 
                    slot="end" 
                    size="small" 
                    class="chevron-btn">
                    <ion-icon 
                      [name]="selectedNutrient?.nutrientKey === nutrient.nutrientKey ? 'chevron-down-outline' : 'chevron-forward-outline'">
                    </ion-icon>
                  </ion-button>
                </ion-item>

                <ng-container *ngIf="selectedNutrient?.nutrientKey === nutrient.nutrientKey">
                  <ion-item lines="none" class="drilldown-row nutrient-drilldown">
                    <div class="drilldown-content">
                      <ng-container *ngIf="selectedNutrient && selectedNutrient.foods?.length">
                        <ng-container *ngFor="let food of selectedNutrient.foods; trackBy: trackById">
                          <div class="detail-item clickable-food" (click)="food.name && navigateToFood(food.name)">
                            <span class="detail-name">
                              <span *ngIf="food.brandName" class="brand-name">{{ food.brandName }} - </span>{{ food.name }}
                            </span>
                            <span class="detail-amount">{{ formatAmountWithFoodUnit(food) }}</span>
                          </div>
                        </ng-container>
                      </ng-container>
                      <div *ngIf="selectedNutrient && !selectedNutrient.foods?.length" class="empty-detail-message">
                        <span>No foods logged for this nutrient yet.</span>
                      </div>
                    </div>
                  </ion-item>
                </ng-container>
                
              </ng-container>
            </ion-list>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Foods View -->
      <div *ngIf="viewMode === 'foods'" class="breakdown-container">
        <!-- Empty State -->
        <div *ngIf="!hasFoodEntries" class="empty-state">
          <div class="empty-state-content">
            <ion-icon name="nutrition-outline" class="empty-state-icon"></ion-icon>
            <h2>Nothing logged yet</h2>
            <p>No meals or foods have been logged for this date.</p>
            <p>Head over to the Chat tab to start tracking your nutrition!</p>
          </div>
        </div>

        <!-- One card per food entry -->
        <ng-container *ngIf="hasFoodEntries">
          <ion-card
            *ngFor="let entry of detailedData?.dailySummary?.foodEntries; trackBy: trackByEntryId"
            [class.expanded]="selectedFood && entryContainsSelectedFood(entry)"
          >
            <!-- Entry Header -->
            <ion-card-header>
              <ion-card-title>{{ entry.entryName | titlecase }}</ion-card-title>
            </ion-card-header>

            <!-- Entry Content -->
            <ion-card-content>
              <ion-list>
                <ng-container *ngFor="let food of entry?.foods; trackBy: trackById">
                  <!-- Food Row -->
                  <ion-item 
                    (click)="selectFood(food)" 
                    [class.selected]="isSameFood(selectedFood, food)">
                    <div class="breakdown-item">
                      <div class="primary-info">
                        <span class="name">
                          <span *ngIf="food.brandName" class="brand-name">
                            {{ food.brandName }} - 
                          </span>{{ food.name }}
                        </span>
                        <span class="amount">
                          {{ formatQuantity(food.totalAmount) }} {{ food.unit }}
                        </span>
                      </div>
                    </div>

                    <!-- Action Buttons -->
                    <ion-button fill="clear" slot="end" size="small" class="action-btn" 
                                (click)="openActionMenu($event, food, 'food')">
                      <ion-icon name="ellipsis-vertical"></ion-icon>
                    </ion-button>
                    <ion-button fill="clear" slot="end" size="small" class="chevron-btn">
                      <ion-icon 
                        [name]="isSameFood(selectedFood, food) 
                                ? 'chevron-down-outline' 
                                : 'chevron-forward-outline'">
                      </ion-icon>
                    </ion-button>
                  </ion-item>

                  <!-- Drilldown Section -->
                  <ng-container *ngIf="isSameFood(selectedFood, food)">
                    <ion-item lines="none" class="drilldown-row food-drilldown">
                      <div class="drilldown-content">
                        <ng-container *ngIf="selectedFood?.nutrients?.length">
                          
                          <!-- Macronutrients -->
                          <div *ngIf="selectedFoodMacronutrients.length" class="nutrient-section">
                            <h4 class="nutrient-section-title">Macronutrients</h4>
                            <ng-container *ngFor="let nutrient of selectedFoodMacronutrients; trackBy: trackById">
                              <div class="detail-item clickable-nutrient"
                                  (click)="navigateToNutrient(nutrient.nutrientKey)">
                                <span class="detail-name">{{ nutrient.nutrientName || nutrient.nutrientKey }}</span>
                                <span class="detail-amount">{{ nutrient.amount?.toFixed(1) }} {{ nutrient.unit }}</span>
                              </div>
                            </ng-container>
                          </div>

                          <!-- Micronutrients -->
                          <div *ngIf="selectedFoodMicronutrients.length" class="nutrient-section">
                            <h4 class="nutrient-section-title">Micronutrients</h4>
                            <ng-container *ngFor="let nutrient of selectedFoodMicronutrients; trackBy: trackById">
                              <div class="detail-item clickable-nutrient"
                                  (click)="navigateToNutrient(nutrient.nutrientKey)">
                                <span class="detail-name">{{ nutrient.nutrientName || nutrient.nutrientKey }}</span>
                                <span class="detail-amount">{{ nutrient.amount?.toFixed(1) }} {{ nutrient.unit }}</span>
                              </div>
                            </ng-container>
                          </div>

                        </ng-container>

                        <!-- Fallback if no nutrients -->
                        <div *ngIf="selectedFood && !selectedFood.nutrients?.length" 
                            class="empty-detail-message">
                          <span>No nutrient data available for this food.</span>
                        </div>
                      </div>
                    </ion-item>
                  </ng-container>
                </ng-container>
              </ion-list>
              <div class="entry-timestamp">
                {{ entry.createdDateUtc | date:'shortTime' }}
              </div>
            </ion-card-content>
          </ion-card>
        </ng-container>
      </div>

      


    </div>
  </div>
</ion-content>

<!-- Entry Action Menu Popover -->
<ion-popover
  #popover
  [isOpen]="isPopoverOpen"
  [event]="popoverEvent"
  (didDismiss)="isPopoverOpen = false"
  showBackdrop="true">
  <ng-template>
    <app-entry-action-menu
      [entry]="selectedEntry"
      (actionSelected)="handleActionSelected($event)">
    </app-entry-action-menu>
  </ng-template>
</ion-popover>

