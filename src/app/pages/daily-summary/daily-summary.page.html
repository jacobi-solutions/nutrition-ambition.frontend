<app-header 
  [title]="'Daily Summary'" 
  [showBackButton]="false" 
  [selectedDate]="selectedDate"
  (dateChanged)="onDateChanged($event)"
  (previousDay)="onPreviousDay()"
  (nextDay)="onNextDay()"
  (login)="onLogin()"
  (logout)="onLogout()"
  (refresh)="onRefresh()">
</app-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Pull-to-refresh functionality -->
  <ion-refresher slot="fixed" (ionRefresh)="onRefresh($event)">
    <ion-refresher-content
      pullingText="Pull to refresh"
      refreshingSpinner="circles"
      refreshingText="Refreshing...">
    </ion-refresher-content>
  </ion-refresher>

  <div class="main-content-wrapper">
    <div *ngIf="detailedLoading" class="loading-container">
      <ion-spinner name="circular"></ion-spinner>
    </div>

    <div *ngIf="detailedError" class="error-message">
      <ion-icon name="alert-circle-outline" class="error-icon"></ion-icon>
      <div class="error-text">
        {{ detailedError || 'An error occurred loading your nutrition data. Please try again later.' }}
      </div>
    </div>

    <div *ngIf="!detailedLoading && !detailedError">
      <ion-segment [(ngModel)]="viewMode" (ionChange)="segmentChanged($event)" class="segment-toggle">
        <ion-segment-button value="nutrients">
          <ion-label>Nutrients</ion-label>
        </ion-segment-button>
        <ion-segment-button value="foods">
          <ion-label>Foods</ion-label>
        </ion-segment-button>
      </ion-segment>

      <!-- Nutrients View -->
      <div *ngIf="viewMode === 'nutrients'" class="breakdown-container">
        <!-- Macronutrients Card -->
        <ion-card [class.expanded]="selectedNutrient">
          <ion-card-header>
            <div class="card-header-with-toggle">
              <ion-card-title>Macronutrients</ion-card-title>
              <ion-button fill="clear" size="small" class="toggle-btn" (click)="toggleMacroChartView()">
                <ion-icon [name]="showMacroCharts ? 'list' : 'bar-chart'"></ion-icon>
              </ion-button>
            </div>
          </ion-card-header>
          <ion-card-content>
            <!-- List View -->
            <ion-list *ngIf="!showMacroCharts" [class.expanded]="selectedNutrient && isLastItem(selectedNutrient, macronutrientList)">
              <ng-container *ngFor="let nutrient of macronutrientList; trackBy: trackById">
                <ion-item
                  class="nutrient-entry"
                  (click)="selectNutrient(nutrient)"
                  [class.selected]="nutrient.isSelected">
                  <div class="breakdown-item">
                    <div class="primary-info">
                      <span class="name">{{ nutrient.nutrientName || nutrient.nutrientKey }}</span>
                      <span class="amount">{{ formatConsumedTarget(nutrient) }}</span>
                    </div>
                  </div>

                  <ion-button
                    fill="clear"
                    slot="end"
                    size="small"
                    class="action-btn"
                    (click)="openActionMenu($event, nutrient, 'nutrient')">
                    <ion-icon name="ellipsis-vertical"></ion-icon>
                  </ion-button>

                  <ion-button
                    fill="clear"
                    slot="end"
                    size="small"
                    class="chevron-btn">
                    <ion-icon
                      [name]="nutrient.isSelected ? 'chevron-down-outline' : 'chevron-forward-outline'">
                    </ion-icon>
                  </ion-button>
                </ion-item>

                <ng-container *ngIf="selectedNutrient?.nutrientKey === nutrient.nutrientKey">
                  <ion-item lines="none" class="drilldown-row nutrient-drilldown">
                    <div class="drilldown-content">
                      <ng-container *ngIf="selectedNutrient && selectedNutrient.foods?.length">
                        <ng-container *ngFor="let food of selectedNutrient.foods; trackBy: trackById">
                          <div class="detail-item clickable-food" (click)="food.name && navigateToFood(food.name)">
                            <span class="detail-name">
                              <span *ngIf="food.brandName" class="brand-name">{{ food.brandName }} - </span>{{ food.name }}
                            </span>
                            <span class="detail-amount">{{ formatAmountWithFoodUnit(food) }}</span>
                          </div>
                        </ng-container>
                      </ng-container>
                      <div *ngIf="selectedNutrient && !selectedNutrient.foods?.length" class="empty-detail-message">
                        <span>No foods logged for this nutrient yet.</span>
                      </div>
                    </div>
                  </ion-item>
                </ng-container>


              </ng-container>
            </ion-list>

            <!-- Chart View -->
            <app-macronutrients-chart
              *ngIf="showMacroCharts"
              [nutrients]="nutrientsDisplay">
            </app-macronutrients-chart>
          </ion-card-content>
        </ion-card>

        <!-- Electrolytes Card -->
        <ion-card [class.expanded]="selectedNutrient">
          <ion-card-header>
            <div class="card-header-with-toggle">
              <ion-card-title>Electrolytes</ion-card-title>
              <ion-button fill="clear" size="small" class="toggle-btn" (click)="toggleElectrolyteChartView()">
                <ion-icon [name]="showElectrolyteCharts ? 'list' : 'bar-chart'"></ion-icon>
              </ion-button>
            </div>
          </ion-card-header>
          <ion-card-content>
            <!-- List View -->
            <ion-list *ngIf="!showElectrolyteCharts" [class.expanded]="selectedNutrient && isLastItem(selectedNutrient, electrolyteList)">
              <ng-container *ngFor="let nutrient of electrolyteList; trackBy: trackById">
                <ion-item
                  class="nutrient-entry"
                  (click)="selectNutrient(nutrient)"
                  [class.selected]="nutrient.isSelected">
                  <div class="breakdown-item">
                    <div class="primary-info">
                      <span class="name">{{ nutrient.nutrientName || nutrient.nutrientKey }}</span>
                      <span class="amount">{{ formatConsumedTarget(nutrient) }}</span>
                    </div>
                  </div>

                  <ion-button
                    fill="clear"
                    slot="end"
                    size="small"
                    class="action-btn"
                    (click)="openActionMenu($event, nutrient, 'nutrient')">
                    <ion-icon name="ellipsis-vertical"></ion-icon>
                  </ion-button>

                  <ion-button
                    fill="clear"
                    slot="end"
                    size="small"
                    class="chevron-btn">
                    <ion-icon
                      [name]="nutrient.isSelected ? 'chevron-down-outline' : 'chevron-forward-outline'">
                    </ion-icon>
                  </ion-button>
                </ion-item>

                <ng-container *ngIf="selectedNutrient?.nutrientKey === nutrient.nutrientKey">
                  <ion-item lines="none" class="drilldown-row nutrient-drilldown">
                    <div class="drilldown-content">
                      <ng-container *ngIf="selectedNutrient && selectedNutrient.foods?.length">
                        <ng-container *ngFor="let food of selectedNutrient.foods; trackBy: trackById">
                          <div class="detail-item clickable-food" (click)="food.name && navigateToFood(food.name)">
                            <span class="detail-name">
                              <span *ngIf="food.brandName" class="brand-name">{{ food.brandName }} - </span>{{ food.name }}
                            </span>
                            <span class="detail-amount">{{ formatAmountWithFoodUnit(food) }}</span>
                          </div>
                        </ng-container>
                      </ng-container>
                      <div *ngIf="selectedNutrient && !selectedNutrient.foods?.length" class="empty-detail-message">
                        <span>No foods logged for this nutrient yet.</span>
                      </div>
                    </div>
                  </ion-item>
                </ng-container>

              </ng-container>
            </ion-list>

            <!-- Chart View -->
            <app-electrolytes-chart
              *ngIf="showElectrolyteCharts"
              [nutrients]="nutrientsDisplay">
            </app-electrolytes-chart>
          </ion-card-content>
        </ion-card>

        <!-- Vitamins Card -->
        <ion-card [class.expanded]="selectedNutrient">
          <ion-card-header>
            <div class="card-header-with-toggle">
              <ion-card-title>Vitamins</ion-card-title>
              <ion-button fill="clear" size="small" class="toggle-btn" (click)="toggleVitaminChartView()">
                <ion-icon [name]="showVitaminCharts ? 'list' : 'bar-chart'"></ion-icon>
              </ion-button>
            </div>
          </ion-card-header>
          <ion-card-content>
            <!-- List View -->
            <ion-list *ngIf="!showVitaminCharts" [class.expanded]="selectedNutrient && isLastItem(selectedNutrient, vitaminList)">
              <ng-container *ngFor="let nutrient of vitaminList; trackBy: trackById">
                <ion-item
                  class="nutrient-entry"
                  (click)="selectNutrient(nutrient)"
                  [class.selected]="nutrient.isSelected">
                  <div class="breakdown-item">
                    <div class="primary-info">
                      <span class="name">{{ nutrient.nutrientName || nutrient.nutrientKey }}</span>
                      <span class="amount">{{ formatConsumedTarget(nutrient) }}</span>
                    </div>
                  </div>

                  <ion-button
                    fill="clear"
                    slot="end"
                    size="small"
                    class="action-btn"
                    (click)="openActionMenu($event, nutrient, 'nutrient')">
                    <ion-icon name="ellipsis-vertical"></ion-icon>
                  </ion-button>

                  <ion-button
                    fill="clear"
                    slot="end"
                    size="small"
                    class="chevron-btn">
                    <ion-icon
                      [name]="nutrient.isSelected ? 'chevron-down-outline' : 'chevron-forward-outline'">
                    </ion-icon>
                  </ion-button>
                </ion-item>

                <ng-container *ngIf="selectedNutrient?.nutrientKey === nutrient.nutrientKey">
                  <ion-item lines="none" class="drilldown-row nutrient-drilldown">
                    <div class="drilldown-content">
                      <ng-container *ngIf="selectedNutrient && selectedNutrient.foods?.length">
                        <ng-container *ngFor="let food of selectedNutrient.foods; trackBy: trackById">
                          <div class="detail-item clickable-food" (click)="food.name && navigateToFood(food.name)">
                            <span class="detail-name">
                              <span *ngIf="food.brandName" class="brand-name">{{ food.brandName }} - </span>{{ food.name }}
                            </span>
                            <span class="detail-amount">{{ formatAmountWithFoodUnit(food) }}</span>
                          </div>
                        </ng-container>
                      </ng-container>
                      <div *ngIf="selectedNutrient && !selectedNutrient.foods?.length" class="empty-detail-message">
                        <span>No foods logged for this nutrient yet.</span>
                      </div>
                    </div>
                  </ion-item>
                </ng-container>
              </ng-container>
            </ion-list>

            <!-- Chart View -->
            <div *ngIf="showVitaminCharts" style="padding: 20px;">
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-width: 400px; margin: 0 auto;">
                <div *ngFor="let vitamin of vitaminSquares"
                     [style.background-color]="vitamin.color"
                     style="aspect-ratio: 1; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: bold;">
                  {{ vitamin.label }}
                </div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Micronutrients Card -->
        <ion-card [class.expanded]="selectedNutrient">
          <ion-card-header>
            <ion-card-title>Micronutrients</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list [class.expanded]="selectedNutrient && isLastItem(selectedNutrient, micronutrientList)">
              <ng-container *ngFor="let nutrient of micronutrientList; trackBy: trackById">
                <ion-item
                  class="nutrient-entry"
                  (click)="selectNutrient(nutrient)"
                  [class.selected]="nutrient.isSelected">
                  <div class="breakdown-item">
                    <div class="primary-info">
                      <span class="name">{{ nutrient.nutrientName || nutrient.nutrientKey }}</span>
                      <span class="amount">{{ formatConsumedTarget(nutrient) }}</span>
                    </div>
                  </div>

                  <ion-button
                    fill="clear"
                    slot="end"
                    size="small"
                    class="action-btn"
                    (click)="openActionMenu($event, nutrient, 'nutrient')">
                    <ion-icon name="ellipsis-vertical"></ion-icon>
                  </ion-button>

                  <ion-button
                    fill="clear"
                    slot="end"
                    size="small"
                    class="chevron-btn">
                    <ion-icon
                      [name]="nutrient.isSelected ? 'chevron-down-outline' : 'chevron-forward-outline'">
                    </ion-icon>
                  </ion-button>
                </ion-item>

                <ng-container *ngIf="selectedNutrient?.nutrientKey === nutrient.nutrientKey">
                  <ion-item lines="none" class="drilldown-row nutrient-drilldown">
                    <div class="drilldown-content">
                      <ng-container *ngIf="selectedNutrient && selectedNutrient.foods?.length">
                        <ng-container *ngFor="let food of selectedNutrient.foods; trackBy: trackById">
                          <div class="detail-item clickable-food" (click)="food.name && navigateToFood(food.name)">
                            <span class="detail-name">
                              <span *ngIf="food.brandName" class="brand-name">{{ food.brandName }} - </span>{{ food.name }}
                            </span>
                            <span class="detail-amount">{{ formatAmountWithFoodUnit(food) }}</span>
                          </div>
                        </ng-container>
                      </ng-container>
                      <div *ngIf="selectedNutrient && !selectedNutrient.foods?.length" class="empty-detail-message">
                        <span>No foods logged for this nutrient yet.</span>
                      </div>
                    </div>
                  </ion-item>
                </ng-container>
                
              </ng-container>
            </ion-list>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Foods View -->
      <div *ngIf="viewMode === 'foods'" class="breakdown-container">
        <!-- Empty State -->
        <div *ngIf="!hasFoodEntries" class="empty-state">
          <div class="empty-state-content">
            <ion-icon name="nutrition-outline" class="empty-state-icon"></ion-icon>
            <h2>Nothing logged yet</h2>
            <p>No meals or foods have been logged for this date.</p>
            <p>Head over to the Chat tab to start tracking your nutrition!</p>
          </div>
        </div>

        <!-- One card per food entry -->
        <ng-container *ngIf="hasFoodEntries">
          <ng-container *ngFor="let entry of foodEntriesDisplay; trackBy: trackByEntryId">

            <!-- Show food-selection component when editing any food in this entry -->
            <div *ngIf="entry.hasEditingFood" class="editing-entry-container">
              <!-- Loading state while fetching edit data -->
              <ion-card *ngIf="isLoadingEdit" class="edit-loading-card">
                <ion-card-header>
                  <ion-card-title>{{ entry.entryName | titlecase }}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                  <div class="edit-loading">
                    <ion-spinner name="dots" color="medium"></ion-spinner>
                    <span>Loading edit data</span>
                  </div>
                </ion-card-content>
              </ion-card>

              <!-- Food selection component for editing (replaces entire card) -->
              <app-food-selection
                *ngIf="!isLoadingEdit && editingMessage"
                [message]="editingMessage"
                (editConfirmed)="onEditConfirmed($event)"
                (selectionCanceled)="onEditCanceled()">
              </app-food-selection>
            </div>

            <!-- Normal Entry Card (when not editing any food in this entry) -->
            <ion-card
              *ngIf="!entry.hasEditingFood"
              [class.expanded]="entry.hasSelectedFood"
            >
              <!-- Entry Header -->
              <ion-card-header>
                <ion-card-title>{{ entry.entryName | titlecase }}</ion-card-title>
              </ion-card-header>

              <!-- Entry Content -->
              <ion-card-content>
                <ion-list>
                  <ng-container *ngFor="let food of entry?.foodsDisplay; trackBy: trackById">
                    <!-- Normal Food Row -->
                    <ion-item
                      (click)="selectFood(food)"
                      [class.selected]="food.isSelected">
                    <div class="breakdown-item">
                      <div class="primary-info">
                        <span class="name">
                          <span *ngIf="food.brandName" class="brand-name">
                            {{ food.brandName }} -
                          </span>{{ food.displayName | titlecase }}
                        </span>
                        <span class="amount">
                          {{ food.servingDisplay }}
                        </span>
                      </div>
                    </div>

                    <!-- Action Buttons -->
                    <ion-button fill="clear" slot="end" size="small" class="action-btn"
                                (click)="openActionMenu($event, food, 'food')">
                      <ion-icon name="ellipsis-vertical"></ion-icon>
                    </ion-button>
                    <ion-button fill="clear" slot="end" size="small" class="info-btn"
                                (click)="showFoodNutrients($event, food)">
                      <ion-icon
                        [name]="foodShowingNutrients?.foodId === food.foodId
                                ? 'information-circle'
                                : 'information-circle-outline'">
                      </ion-icon>
                    </ion-button>
                    <ion-button fill="clear" slot="end" size="small" class="chevron-btn">
                      <ion-icon
                        [name]="food.isSelected
                                ? 'chevron-down-outline'
                                : 'chevron-forward-outline'">
                      </ion-icon>
                    </ion-button>
                  </ion-item>

                    <!-- Multi-component food expansion: Show components as individual food-like items -->
                    <ng-container *ngIf="food.isSelected && food.isMultiComponent && food.componentsDisplay?.length">
                    <div class="components-container">
                      <ng-container *ngFor="let component of food.componentsDisplay; trackBy: trackById">
                        <!-- Component Row (looks like a single-component food) -->
                        <ion-item
                          class="component-item"
                          (click)="selectComponent(component)"
                          [class.selected]="component.isSelected">
                          <div class="breakdown-item">
                            <div class="primary-info">
                              <span class="name">
                                <span *ngIf="component.brandName" class="brand-name">
                                  {{ component.brandName }} -
                                </span>{{ component.name | titlecase }}
                                <span *ngIf="component.inferred" class="inferred-indicator"> (inferred)</span>
                              </span>
                              <span class="amount">
                                {{ component.formattedAmount }}
                              </span>
                            </div>
                          </div>

                          <!-- Action Buttons -->
                          <ion-button fill="clear" slot="end" size="small" class="action-btn"
                                      (click)="openActionMenu($event, food, 'food', component)">
                            <ion-icon name="ellipsis-vertical"></ion-icon>
                          </ion-button>
                          <ion-button fill="clear" slot="end" size="small" class="info-btn">
                            <ion-icon
                              [name]="component.isSelected
                                      ? 'information-circle'
                                      : 'information-circle-outline'">
                            </ion-icon>
                          </ion-button>
                        </ion-item>

                        <!-- Component Drilldown (standard nutrient breakdown) -->
                        <ng-container *ngIf="component.isSelected">
                          <ion-item lines="none" class="component-drilldown drilldown-row food-drilldown">
                            <div class="drilldown-content">
                              <ng-container *ngIf="selectedComponent?.nutrients?.length">
                                
                                <!-- Macronutrients -->
                                <div *ngIf="selectedComponentMacronutrients.length" class="nutrient-section">
                                  <h4 class="nutrient-section-title">Macronutrients</h4>
                                  <ng-container *ngFor="let nutrient of selectedComponentMacronutrients; trackBy: trackById">
                                    <div class="detail-item clickable-nutrient"
                                        (click)="nutrient.nutrientKey && navigateToNutrient(nutrient.nutrientKey)">
                                      <span class="detail-name">{{ nutrient.nutrientName || nutrient.nutrientKey }}</span>
                                      <span class="detail-amount">{{ nutrient.amount?.toFixed(1) }} {{ nutrient.unit }}</span>
                                    </div>
                                  </ng-container>
                                </div>

                                <!-- Micronutrients -->
                                <div *ngIf="selectedComponentMicronutrients.length" class="nutrient-section">
                                  <h4 class="nutrient-section-title">Micronutrients</h4>
                                  <ng-container *ngFor="let nutrient of selectedComponentMicronutrients; trackBy: trackById">
                                    <div class="detail-item clickable-nutrient"
                                        (click)="nutrient.nutrientKey && navigateToNutrient(nutrient.nutrientKey)">
                                      <span class="detail-name">{{ nutrient.nutrientName || nutrient.nutrientKey }}</span>
                                      <span class="detail-amount">{{ nutrient.amount?.toFixed(1) }} {{ nutrient.unit }}</span>
                                    </div>
                                  </ng-container>
                                </div>

                              </ng-container>

                              <!-- Fallback if no nutrients -->
                              <div *ngIf="selectedComponent && !selectedComponent.nutrients?.length" 
                                  class="empty-detail-message">
                                <span>No nutrient data available for this component.</span>
                              </div>
                            </div>
                          </ion-item>
                        </ng-container>
                      </ng-container>
                    </div>
                  </ng-container>

                    <!-- Nutrient drilldown when info icon is clicked -->
                    <ng-container *ngIf="foodShowingNutrients?.foodId === food.foodId">
                    <ion-item lines="none" class="drilldown-row food-drilldown">
                      <div class="drilldown-content">
                        <ng-container *ngIf="foodShowingNutrients?.nutrients?.length">
                          
                          <!-- Macronutrients -->
                          <div *ngIf="foodShowingNutrientsMacros.length" class="nutrient-section">
                            <h4 class="nutrient-section-title">Macronutrients</h4>
                            <ng-container *ngFor="let nutrient of foodShowingNutrientsMacros; trackBy: trackById">
                              <div class="detail-item clickable-nutrient"
                                  (click)="navigateToNutrient(nutrient.nutrientKey)">
                                <span class="detail-name">{{ nutrient.nutrientName || nutrient.nutrientKey }}</span>
                                <span class="detail-amount">{{ nutrient.amount?.toFixed(1) }} {{ nutrient.unit }}</span>
                              </div>
                            </ng-container>
                          </div>

                          <!-- Micronutrients -->
                          <div *ngIf="foodShowingNutrientsMicros.length" class="nutrient-section">
                            <h4 class="nutrient-section-title">Micronutrients</h4>
                            <ng-container *ngFor="let nutrient of foodShowingNutrientsMicros; trackBy: trackById">
                              <div class="detail-item clickable-nutrient"
                                  (click)="navigateToNutrient(nutrient.nutrientKey)">
                                <span class="detail-name">{{ nutrient.nutrientName || nutrient.nutrientKey }}</span>
                                <span class="detail-amount">{{ nutrient.amount?.toFixed(1) }} {{ nutrient.unit }}</span>
                              </div>
                            </ng-container>
                          </div>

                        </ng-container>

                        <!-- Fallback if no nutrients -->
                        <div *ngIf="foodShowingNutrients && !foodShowingNutrients.nutrients?.length"
                            class="empty-detail-message">
                          <span>No nutrient data available for this food.</span>
                        </div>
                      </div>
                    </ion-item>
                  </ng-container>
                </ng-container>
              </ion-list>
              <!-- <div class="entry-timestamp">
                {{ entry.createdDateUtc | date:'shortTime' }}
              </div> -->
            </ion-card-content>
          </ion-card>
          </ng-container>
        </ng-container>
      </div>

    </div>
  </div>
</ion-content>

<!-- Entry Action Menu Popover -->
<ion-popover
  #popover
  [isOpen]="isPopoverOpen"
  [event]="popoverEvent"
  (didDismiss)="isPopoverOpen = false"
  showBackdrop="true">
  <ng-template>
    <app-entry-action-menu
      [entry]="selectedEntry"
      (actionSelected)="handleActionSelected($event)">
    </app-entry-action-menu>
  </ng-template>
</ion-popover>

